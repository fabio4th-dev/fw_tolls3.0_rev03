<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas - Login</title>
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="shortcut icon" href="fw_mini.ico">
    <link rel="icon" type="image/png" href="fw_mini.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* Efeito hover para botão de fechar do zoom */
        .image-modal-close:hover {
            background: rgba(96, 96, 96, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.8) !important;
            transform: scale(1.15) rotate(90deg) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5) !important;
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login Container */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        
        .login-logo-fw {
            width: 180px;
            margin: 0 auto 20px;
        }
        
        .login-logo-fw img {
            width: 100%;
            height: auto;
        }
        
        .login-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .login-form {
            position: relative;
            z-index: 1;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: white;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .form-group input.error {
            border-color: var(--danger-color);
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .login-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            position: relative;
            z-index: 1;
        }
        
        .login-logo-delservin {
            width: 120px;
        }
        
        .login-logo-altercon {
            width: 90px;
        }
        
        .login-footer img {
            width: 100%;
            height: auto;
        }
        
        .login-error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger-color);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .login-error.show {
            display: block;
        }
        
        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 12px;
            padding: 2px;
            margin-bottom: 5px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(25deg);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: relative;
            z-index: 1;
            margin-bottom: 2px;
        }
        
        .logo-fw {
            width: 140px;
            flex-shrink: 0;
            margin-left: 25px;
            position: relative;
            top: 42px;
        }
        
        .logo-fw img {
            width: 100%;
            height: auto;
            margin-left: 20px;
            margin-top: 10px;
            max-height: 650px;
            object-fit: contain;
        }
        
        .header-center {
            text-align: center;
            flex-grow: 1;
            padding: 0 20px;
        }
        
        .project-title {
            font-size: 40px;
            font-weight: 700;
            position: relative;
            left: 70px;
            z-index: 1;
            margin-bottom: 5px;
        }
        
        .project-subtitle {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .header-right {
            display: flex;
            gap: 30px;
            flex-shrink: 0;
        }
        
        .logo-right {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-right img {
            width: 100%;
            height: auto;
            max-height: 60px;
            object-fit: contain;
        }
        
        .logo-delservin {
            width: 130px;
            position: relative;
            top: 38px;
            flex-shrink: 0;
        }
        
        .logo-altercon {
            width: 100px;
            position: relative;
            top: 38px;
            margin-right: 30px;
            flex-shrink: 0;
        }
        
        .user-info {
            position: absolute;
            top: 0px;
            right: 20px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-welcome {
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .project-info {
            display: flex;
            gap: 20px;
            position: relative;
            z-index: 1;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .info-item {
            text-align: center;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .tabs-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background-color: var(--light-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 18px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .tab-button.active {
            background-color: white;
            color: var(--secondary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--secondary-color);
        }
        
        .tab-button.hidden {
            display: none;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--secondary-color);
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--secondary-color);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card.hidden {
            display: none;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--secondary-color);
        }
        
        .progress-container {
            margin-bottom: 18px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.8s ease;
        }
        
        .progress-fill.planned {
            background-color: var(--secondary-color);
        }
        
        .progress-fill.actual {
            background-color: var(--success-color);
        }
        
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            height: 450px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-title i {
            color: var(--secondary-color);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status-completed {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .status-ontrack {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }
        
        .status-delayed {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        /* Formulário de cadastro */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        label.required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s ease;
            background-color: white;
            color: var(--text-color);
        }
        
        input::placeholder, select::placeholder, textarea::placeholder {
            color: var(--gray-color);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        input.error, select.error, textarea.error {
            border-color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Área de captura de imagem */
        .image-capture-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .camera-area {
            width: 100%;
            height: 300px;
            background-color: var(--light-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .camera-area img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .camera-placeholder {
            text-align: center;
            color: var(--gray-color);
        }
        
        .camera-placeholder i {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Lista de ferramentas */
        .tools-list {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background-color: var(--light-color);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .tool-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .action-btn-view {
            color: var(--secondary-color);
        }
        
        .action-btn-edit {
            color: var(--warning-color);
        }
        
        .action-btn-delete {
            color: var(--danger-color);
        }
        
        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-color);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Configuração do banco de dados */
        .config-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .config-step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .config-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-title i {
            color: var(--secondary-color);
        }
        
        .step-content {
            margin-left: 35px;
        }
        
        .step-content p {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .step-content a {
            color: var(--secondary-color);
            text-decoration: none;
        }
        
        .step-content a:hover {
            text-decoration: underline;
        }
        
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
            font-size: 14px;
        }
        
        .storage-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--gray-color);
        }
        
        .status-indicator.online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ============================================ */
        /* ESTILOS ESPECÍFICOS PARA A ABA MAPEAMENTO */
        /* ============================================ */
        
        .mapping-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .mapping-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .mapping-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .mapping-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid var(--light-color);
            transition: all 0.3s ease;
        }
        
        .mapping-thumbnail:hover {
            border-color: var(--secondary-color);
        }
        
        .mapping-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .mapping-card p {
            color: var(--gray-color);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .mapping-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-color);
        }
        
        .mapping-stat {
            text-align: center;
        }
        
        .mapping-stat-value {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .mapping-stat-label {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Responsividade */
        @media (max-width: 992px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo-fw, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .header-center {
                padding: 0;
            }
            
            .project-info {
                gap: 15px;
            }
            
            .info-item {
                min-width: 80px;
            }
            
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
            
            .mapping-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .tabs-header {
                justify-content: center;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .step-content {
                margin-left: 0;
            }
            
            .header-right {
                gap: 15px;
            }
            
            .logo-delservin {
                width: 100px;
            }
            
            .logo-altercon {
                width: 80px;
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .login-title {
                font-size: 28px;
            }
            
            .mapping-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .camera-controls {
                flex-wrap: wrap;
            }
            
            .login-box {
                padding: 25px 15px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .mapping-card {
                padding: 15px;
            }
            
            .mapping-thumbnail {
                height: 150px;
            }
        }
        
        /* Notificações */
        .notification {
            position: fixed;
            top: 150px;
            right: 20px;
            padding: 10px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1100;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification-success {
            background-color: var(--success-color);
        }
        
        .notification-error {
            background-color: var(--danger-color);
        }
        
        .notification-warning {
            background-color: var(--warning-color);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loader */
        .loader {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Info de armazenamento */
        .storage-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .storage-info p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .storage-info .storage-type {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--light-color);
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .storage-info.hidden {
            display: none;
        }
        
        .export-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Backup Button */
        .backup-btn {
            background-color: #8e44ad;
            color: white;
        }
        
        .backup-btn:hover {
            background-color: #7d3c98;
        }
        
        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Tool Status Colors */
        .status-available { color: var(--success-color); }
        .status-inuse { color: var(--secondary-color); }
        .status-maintenance { color: var(--warning-color); }
        .status-damaged { color: var(--danger-color); }
        
        /* QR Code Styles */
        .qrcode-container {
            text-align: center;
            padding: 20px;
        }
        
        .qrcode-container canvas {
            max-width: 200px;
            max-height: 200px;
            margin: 0 auto 20px;
        }
        
        /* Number input spinner */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 30px;
        }
        
        /* Money input */
        .money-input {
            position: relative;
        }
        
        .money-input::before {
            content: "R$";
            position: absolute;
            left: 12px;
            top: 12px;
            color: var(--gray-color);
        }
        
        .money-input input {
            padding-left: 40px;
        }
        
        /* Compact table view */
        .compact-view .action-buttons {
            flex-direction: column;
            gap: 4px;
        }
        
        /* Stock indicators */
        .stock-low {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .stock-normal {
            color: var(--success-color);
        }
        
        .stock-high {
            color: var(--warning-color);
        }
        
        /* Footer */
        .site-footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 40px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-version {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Botão de sincronização fixo */
        .auto-sync-btn {
            position: fixed;
            bottom: 20px;
            right: 90px;
            z-index: 999;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .auto-sync-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Correções específicas */
        #cadastro .form-container,
        #cadastro .image-capture-container,
        #database .config-container {
            background-color: white !important;
        }
        
        #cadastro label,
        #cadastro .form-group label,
        #cadastro .section-title,
        #cadastro h4,
        #database .config-step .step-content p,
        #database .config-step .step-content label,
        #database .step-title {
            color: var(--text-color) !important;
            opacity: 1 !important;
            font-weight: 500 !important;
        }
        
        #cadastro input,
        #cadastro select,
        #cadastro textarea,
        #database input,
        #database select {
            background-color: white !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
            background-size: 16px !important;
            padding-right: 40px !important;
        }

        /* ============================================ */
        /* ESTILOS PARA MINIATURAS DE IMAGEM (NOVO) */
        /* ============================================ */

        /* Estilo para miniaturas */
        .tool-thumbnail {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tool-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* Efeito de overlay na miniatura */
        .tool-thumbnail-container {
            position: relative;
            display: inline-block;
        }

        /* Modal de imagem ampliada */
        .image-modal {
            background-color: rgba(0, 0, 0, 0.95) !important;
        }

        .image-modal-content {
            max-width: 95vw;
            max-height: 95vh;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .image-modal-body {
            padding: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
        }

        .image-modal-body img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        /* Botão de fechar no modal de imagem */
        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Legenda da imagem */
        .image-caption {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 20px 10px 10px 10px;
            border-radius: 0 0 8px 8px;
        }

        .image-caption h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .image-caption p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Animações */
        @keyframes zoomIn {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-modal {
            animation: fadeIn 0.3s ease;
        }

        .image-modal-body img {
            animation: zoomIn 0.3s ease 0.1s both;
        }

        /* Responsividade para miniaturas */
        @media (max-width: 768px) {
            .tool-thumbnail {
                width: 35px !important;
                height: 35px !important;
            }
            
            .tool-thumbnail-container::after {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }

        /* Placeholder sem imagem */
        .no-image-placeholder {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .no-image-placeholder:hover {
            background-color: var(--light-color) !important;
            transform: scale(1.05);
        }

        .no-image-placeholder i {
            transition: all 0.3s ease;
        }

        .no-image-placeholder:hover i {
            color: var(--secondary-color) !important;
        }
        
        /* ============================================ */
        /* NOVOS ESTILOS - BOTÕES */
        /* ============================================ */
        
        /* Botão de envio para nuvem fixo */
        .cloud-upload-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .cloud-upload-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Botões de status */
        .status-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-filter-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }
        
        .status-filter-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .status-filter-btn.active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }
        
        .status-available-btn {
            background-color: var(--success-color);
        }
        
        .status-inuse-btn {
            background-color: var(--secondary-color);
        }
        
        .status-maintenance-btn {
            background-color: var(--warning-color);
        }
        
        .status-damaged-btn {
            background-color: var(--danger-color);
        }
        
        .status-reserved-btn {
            background-color: #8e44ad;
        }
        
        .status-discarded-btn {
            background-color: #7f8c8d;
        }
        
        .status-all-btn {
            background-color: var(--primary-color);
        }

        /* CORREÇÕES ESPECÍFICAS PARA ABA COLABORADOR */
#controle-colaborador * {
    color: var(--text-color) !important;
}

#controle-colaborador .card-title,
#controle-colaborador .section-title,
#controle-colaborador th,
#controle-colaborador .modal-title {
    color: var(--primary-color) !important;
}

#controle-colaborador input,
#controle-colaborador select,
#controle-colaborador textarea {
    color: var(--text-color) !important;
    background-color: white !important;
    border: 1px solid var(--border-color) !important;
}

#controle-colaborador label {
    color: var(--text-color) !important;
    font-weight: 500 !important;
}

#controle-colaborador .error-message {
    color: var(--danger-color) !important;
}

#controle-colaborador .form-container {
    background-color: white !important;
}

#controle-colaborador .search-box i {
    color: var(--gray-color) !important;
}    

</style>
</head>
<body>
    
    <!-- Login Screen (Inicial) -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>
                <h1 class="login-title">Sistema de Controle de Ferramentas</h1>
                <p class="login-subtitle">Faça login para acessar o sistema</p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Credenciais inválidas. Tente novamente.
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email ou Usuário</label>
                    <input type="text" id="loginEmail" placeholder="Digite seu email ou usuário">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha">
                </div>
                
                <button type="button" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
                
                <div style="margin-top: 20px; text-align: center;">
                    <p style="font-size: 14px; opacity: 0.9;">Credenciais de exemplo:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">DEV (Acesso Total)</span>
                            <span style="font-size: 0px;">fabio@fwcompany.com.br / FabioFW123@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Almoxarife</span>
                            <span style="font-size: 10px;">emerson.silva@fwcompany.com.br  EmersonFW1@</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Consultas</span>
                            <span style="font-size: 10px;">fwuser / User123</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <span style="font-size: 12px; display: block;">Outros</span>
                            <span style="font-size: 10px;">raquel@fwcompany.com.br  RaqueL1234</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="login-footer">
                <div class="login-logo-delservin">
                    <img src="Delservin Logo.png" alt="Delservin Logo">
                </div>
                <div class="login-logo-altercon">
                    <img src="Altercon Logo.png" alt="Altercon Logo">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Screen (Após Login) -->
    <div id="dashboardScreen" class="dashboard-container" style="display: none;">
        <header class="dashboard-header">
            <div class="user-info">
                <div class="user-welcome">
                    <i class="fas fa-user"></i>
                    <span id="userWelcomeText">Bem-vindo!</span>
                    <span class="user-badge" id="userRoleBadge">DEV</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
            
            <div class="header-top">
                <div class="logo-fw">
                    <img src="FW Logo.png" alt="FW Logo">
                </div>
                
                <div class="header-center">
                    <h1 class="project-title">Sistema de Controle de Ferramentas</h1>                    
                </div>
                
                <div class="header-right">
                    <div class="logo-right logo-delservin">
                        <img src="Delservin Logo.png" alt="Delservin Logo">
                    </div>
                    <div class="logo-right logo-altercon">
                        <img src="Altercon Logo.png" alt="Altercon Logo">
                    </div>
                </div>
            </div>
            
            <div class="project-info">
                <div class="info-item">
                    <div class="info-label">Total de Itens</div>
                    <div class="info-value" id="totalTools">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Valor Total</div>
                    <div class="info-value" id="totalValue">R$ 0,00</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge status-ontrack" id="storageStatus">Local</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cloud</div>
                    <div class="info-value">
                        <span class="status-badge status-delayed" id="indexedDBStatus">Desconectado</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Última Atualização</div>
                    <div class="info-value" id="lastUpdate">Hoje</div>
                </div>
            </div>
        </header>
        
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-button" data-tab="cadastro" id="cadastroTab">
                    <i class="fas fa-tools"></i> Cadastrar Item
                </button>
                <button class="tab-button" data-tab="catalogo">
                    <i class="fas fa-list"></i> Catálogo de Itens
                </button>
                <button class="tab-button" data-tab="controle-colaborador">
                    <i class="fas fa-users"></i> Controle por Colaborador
                </button>
                <button class="tab-button" data-tab="mapeamento">
                    <i class="fas fa-map"></i> Mapeamento
                </button>
                <button class="tab-button" data-tab="exportar">
                    <i class="fas fa-file-excel"></i> Exportar
                </button>
                <button class="tab-button" data-tab="database" id="databaseTab">
                    <i class="fas fa-database"></i> Banco de Dados
                </button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Estatísticas do Sistema</h2>
                
                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-boxes"></i> Status dos Itens</h3>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Disponíveis</span>
                                <span id="availablePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill actual" id="availableBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Em Uso</span>
                                <span id="inUsePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill planned" id="inUseBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Manutenção</span>
                                <span id="maintenancePercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="maintenanceBar" style="width: 0%; background-color: var(--warning-color)"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Danificados</span>
                                <span id="damagedPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="damagedBar" style="width: 0%; background-color: var(--danger-color)"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Valor por Categoria</h3>
                        <div id="valueStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando dados...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Itens com Estoque Baixo</h3>
                        <div id="lowStockItems">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Carregando dados...</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Distribuição por Localização</h3>
                    <canvas id="locationChart"></canvas>
                </div>
                
                <div class="card" id="backupCard">
                    <h3 class="card-title"><i class="fas fa-download"></i> Backup Rápido</h3>
                    <p style="margin-bottom: 15px;">Faça um backup completo dos seus dados localmente.</p>
                    <div class="btn-group">
                        <button type="button" class="btn backup-btn" id="backupBtn">
                            <i class="fas fa-download"></i> Fazer Backup
                        </button>
                        <button type="button" class="btn btn-warning" id="restoreBtn">
                            <i class="fas fa-upload"></i> Restaurar Backup
                        </button>
                    </div>
                    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                </div>
            </div>
            
            <!-- Cadastro Tab -->
            <div id="cadastro" class="tab-content">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Cadastrar Novo Item</h2>
                
                <div class="form-container">
                    <form id="toolForm">
                        <!-- Campo oculto para usuário será adicionado via JavaScript -->
                        
                        <h4 style="color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-info-circle"></i> Informações Básicas
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="toolName" class="required">Nome do Produto</label>
                                <input type="text" id="toolName" required maxlength="200" placeholder="Ex: Martelo de Borracha">
                                <div class="error-message" id="toolNameError">O nome do produto é obrigatório</div>
                            </div>
                            <div class="form-group">
                                <label for="toolCode" class="required">Código</label>
                                <input type="text" id="toolCode" required maxlength="50" placeholder="Ex: MART-001">
                                <div class="error-message" id="toolCodeError">O código é obrigatório</div>
                            </div>
                            <div class="form-group">
                                <label for="patrimonioNumber">Número do Patrimônio</label>
                                <input type="text" id="patrimonioNumber" maxlength="50" placeholder="Ex: PAT-2023-001">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ncmCode">N.C.M. (Nomenclatura Comum do Mercosul)</label>
                                <input type="text" id="ncmCode" maxlength="20" placeholder="Ex: 8205.70.00 (opcional)">
                            </div>
                            <div class="form-group">
                                <label for="toolCategory" class="required">Categoria</label>
                                <select id="toolCategory" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Ferramentas Elétricas">Ferramentas Elétricas</option>
                                    <option value="Ferramentas Manuais">Ferramentas Manuais</option>
                                    <option value="Equipamentos de Segurança">Equipamentos de Segurança</option>
                                    <option value="Ferramentas à Bateria">Ferramentas à Bateria</option>
                                    <option value="Material de Consumo">Material de Consumo</option>
                                    <option value="EPI">EPI (Equipamento de Proteção Individual)</option>
                                    <option value="Informática">Informática</option>
                                    <option value="Veículos">Veículos</option>
                                    <option value="Outros">Outros</option>
                                </select>
                                <div class="error-message" id="toolCategoryError">Selecione uma categoria</div>
                            </div>
                            <div class="form-group">
                                <label for="toolStatus" class="required">Status</label>
                                <select id="toolStatus" required>
                                    <option value="Disponível">Disponível</option>
                                    <option value="Em Uso">Em Uso</option>
                                    <option value="Manutenção">Em Manutenção</option>
                                    <option value="Danificado">Danificado</option>
                                    <option value="Reservado">Reservado</option>
                                    <option value="Descartado">Descartado</option>
                                </select>
                                <div class="error-message" id="toolStatusError">Selecione um status</div>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-map-marker-alt"></i> Localização e Condição
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="toolLocation" class="required">Localização</label>
                                <select id="toolLocation" required>
                                    <option value="">Selecione uma localização</option>
                                    <option value="Almoxarifado Central">Almoxarifado Central</option>
                                    <option value="Container Mecânica">Container Mecânica</option>
                                    <option value="Container Elétrica">Container Elétrica</option>
                                    <option value="Oficina">Oficina</option>
                                    <option value="Campo">Campo</option>
                                    <option value="Caminhão">Caminhão</option>
                                    <option value="Kombi de Serviço">Kombi de Serviço</option>
                                    <option value="Escritório">Escritório</option>                                    
                                    <option value="Depósito">Depósito</option>
                                </select>
                                <div class="error-message" id="toolLocationError">Selecione uma localização</div>
                            </div>
                            <div class="form-group">
                                <label for="toolCondition" class="required">Condição</label>
                                <select id="toolCondition" required>
                                    <option value="Novo">Novo</option>
                                    <option value="Bom">Bom</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Precisa de Reparo">Precisa de Reparo</option>
                                    <option value="Inutilizável">Inutilizável</option>
                                </select>
                                <div class="error-message" id="toolConditionError">Selecione uma condição</div>
                            </div>
                            <div class="form-group">
                                <label for="notaFiscal">Nº da Nota Fiscal</label>
                                <input type="text" id="notaFiscal" maxlength="50" placeholder="Ex: NF-2023-001234">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-calculator"></i> Dados Financeiros e Estoque
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="unidadeMedida">Unidade de Medida</label>
                                <select id="unidadeMedida">
                                    <option value="UN">UN (Unidade)</option>
                                    <option value="PC">PC (Peça)</option>
                                    <option value="CX">CX (Caixa)</option>
                                    <option value="KG">KG (Quilograma)</option>
                                    <option value="M">M (Metro)</option>
                                    <option value="L">L (Litro)</option>
                                    <option value="PAR">PAR (Par)</option>
                                    <option value="JGO">JGO (Jogo)</option>
                                    <option value="HR">HR (Hora)</option>
                                </select>
                            </div>
                            <div class="form-group money-input">
                                <label for="preco">Preço Unitário (R$)</label>
                                <input type="number" id="preco" min="0" step="0.01" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label for="quantidadeAtual">Quantidade Atual</label>
                                <input type="number" id="quantidadeAtual" min="0" value="1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="estoqueMinimo">Estoque Mínimo</label>
                                <input type="number" id="estoqueMinimo" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="estoqueMaximo">Estoque Máximo</label>
                                <input type="number" id="estoqueMaximo" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="dataCadastro">Data do Cadastro</label>
                                <input type="date" id="dataCadastro" value="">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--light-color);">
                            <i class="fas fa-align-left"></i> Descrições e Observações
                        </h4>
                        
                        <div class="form-group">
                            <label for="toolDescription">Descrição Detalhada</label>
                            <textarea id="toolDescription" rows="3" maxlength="1000" placeholder="Descreva detalhadamente o produto..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="toolObservations">GPS</label>
                            <textarea id="toolObservations" rows="2" maxlength="500" placeholder="Localização exata do item"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="image-capture-container" id="imageCaptureContainer">
                    <h3 class="section-title"><i class="fas fa-camera"></i> Fotografar Item</h3>
                    
                    <div class="camera-area" id="cameraArea">
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <i class="fas fa-camera"></i>
                            <p>Nenhuma imagem selecionada</p>
                        </div>
                        <img id="toolImagePreview" style="display: none;">
                    </div>
                    
                    <div class="camera-controls">
                        <button type="button" class="btn btn-primary" id="captureImageBtn">
                            <i class="fas fa-camera"></i> Tirar Foto
                        </button>
                        <button type="button" class="btn btn-warning" id="uploadImageBtn">
                            <i class="fas fa-upload"></i> Carregar Imagem
                        </button>
                        <button type="button" class="btn btn-danger" id="clearImageBtn">
                            <i class="fas fa-trash"></i> Remover Imagem
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 10px; color: var(--gray-color); font-size: 12px;">
                        Tamanho máximo: 5MB | Formatos: JPG, PNG, GIF
                    </p>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-success" id="saveToolBtn">
                        <i class="fas fa-save"></i> Salvar Item
                    </button>
                    <button type="button" class="btn btn-primary" id="saveAndNewBtn">
                        <i class="fas fa-plus-circle"></i> Salvar e Novo
                    </button>
                    <button type="button" class="btn btn-warning" id="clearFormBtn">
                        <i class="fas fa-eraser"></i> Limpar Formulário
                    </button>
                    <button type="button" class="btn backup-btn" id="generateQRCodeBtn">
                        <i class="fas fa-qrcode"></i> Gerar QR Code
                    </button>
                </div>
            </div>
            
            <!-- Catálogo Tab -->
            <div id="catalogo" class="tab-content">
                <h2 class="section-title"><i class="fas fa-list"></i> Catálogo de Itens</h2>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchTool" placeholder="Buscar por nome, código, patrimônio ou categoria...">
                </div>
                
                <!-- Botões de status -->
                <div class="status-filter-buttons">
                    <button type="button" class="status-filter-btn status-all-btn active" data-status="all">
                        <i class="fas fa-th-list"></i> Todos
                    </button>
                    <button type="button" class="status-filter-btn status-available-btn" data-status="Disponível">
                        <i class="fas fa-check-circle"></i> Disponível
                    </button>
                    <button type="button" class="status-filter-btn status-inuse-btn" data-status="Em Uso">
                        <i class="fas fa-user-check"></i> Em Uso
                    </button>
                    <button type="button" class="status-filter-btn status-maintenance-btn" data-status="Manutenção">
                        <i class="fas fa-tools"></i> Manutenção
                    </button>
                    <button type="button" class="status-filter-btn status-damaged-btn" data-status="Danificado">
                        <i class="fas fa-times-circle"></i> Danificado
                    </button>
                    <button type="button" class="status-filter-btn status-reserved-btn" data-status="Reservado">
                        <i class="fas fa-clock"></i> Reservado
                    </button>
                    <button type="button" class="status-filter-btn status-discarded-btn" data-status="Descartado">
                        <i class="fas fa-trash-alt"></i> Descartado
                    </button>
                    <button type="button" class="btn btn-warning" id="filterLowStockBtn">
                        <i class="fas fa-exclamation-triangle"></i> Estoque Baixo
                    </button>
                </div>
                
                <div class="tools-list">
                    <div class="table-container">
                        <table id="toolsTable">
                            <thead>
                                <tr>
                                    <th>Imagem</th>
                                    <th>Código</th>
                                    <th>Nome do Produto</th>
                                    <th>Patrimônio</th>
                                    <th>Categoria</th>
                                    <th>Status</th>
                                    <th>Localização</th>
                                    <th>Condição</th>
                                    <th>Unidade</th>
                                    <th>Estoque</th>
                                    <th>Preço (R$)</th>
                                    <th>Data Cad.</th>
                                    <th>Usuário Cad.</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="toolsTableBody">
                                <tr id="noToolsRow">
                                    <td colspan="14" style="text-align: center; padding: 40px; color: var(--gray-color);">
                                        Nenhum item cadastrado. Clique em "Cadastrar Item" para adicionar.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="storage-info" id="storageInfo">
                    <p><strong>Informações de Armazenamento:</strong></p>
                    <p id="storageInfoText">Carregando informações...</p>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-warning" id="clearCacheBtn">
                            <i class="fas fa-trash-alt"></i> Limpar Cache Local
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" id="optimizeStorageBtn">
                            <i class="fas fa-compress-alt"></i> Otimizar Armazenamento
                        </button>
                        <button type="button" class="btn btn-sm backup-btn" id="quickBackupBtn">
                            <i class="fas fa-download"></i> Backup Rápido
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Controle por Colaborador Tab -->
<div id="controle-colaborador" class="tab-content">
    <h2 class="section-title" style="color: var(--primary-color) !important;">
        <i class="fas fa-users"></i> Controle por Colaborador
    </h2>
    
    <!-- Lista de colaboradores em cima -->
    <div class="card">
        <h3 class="card-title" style="color: var(--primary-color) !important;">
            <i class="fas fa-list"></i> Lista de Colaboradores
        </h3>
        
        <div class="search-box">
            <i class="fas fa-search" style="color: var(--gray-color) !important;"></i>
            <input type="text" id="searchColaborador" placeholder="Buscar colaborador por nome, matrícula ou setor..." style="color: var(--text-color) !important; background-color: white !important;">
        </div>
        
        <div class="tools-list">
            <div class="table-container">
                <table id="colaboradoresTable">
                    <thead>
                        <tr>
                            <th style="color: var(--primary-color) !important;">Nome</th>
                            <th style="color: var(--primary-color) !important;">Matrícula</th>
                            <th style="color: var(--primary-color) !important;">Setor</th>
                            <th style="color: var(--primary-color) !important;">Cargo</th>
                            <th style="color: var(--primary-color) !important;">Telefone</th>
                            <th style="color: var(--primary-color) !important;">Email</th>
                            <th style="color: var(--primary-color) !important;">Ferramentas</th>
                            <th style="color: var(--primary-color) !important;">Status</th>
                            <th style="color: var(--primary-color) !important;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="colaboradoresTableBody">
                        <tr id="noColaboradoresRow">
                            <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-color) !important;">
                                Nenhum colaborador cadastrado. Cadastre um colaborador para começar.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Cards abaixo da lista -->
    <div class="cards-container">
        <!-- Formulário para cadastrar/atualizar colaborador -->
        <div class="card">
            <h3 class="card-title" style="color: var(--primary-color) !important;">
                <i class="fas fa-user-plus"></i> Cadastrar/Editar Colaborador
            </h3>
            
            <div class="form-container" style="background-color: white !important;">
                <form id="colaboradorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorNome" class="required" style="color: var(--text-color) !important;">
                                Nome do Colaborador
                            </label>
                            <input type="text" id="colaboradorNome" required maxlength="100" 
                                   placeholder="Ex: João da Silva" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                            <div class="error-message" id="colaboradorNomeError" style="color: var(--danger-color) !important;">
                                O nome é obrigatório
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="colaboradorMatricula" class="required" style="color: var(--text-color) !important;">
                                Matrícula
                            </label>
                            <input type="text" id="colaboradorMatricula" required maxlength="50" 
                                   placeholder="Ex: MAT-001" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                            <div class="error-message" id="colaboradorMatriculaError" style="color: var(--danger-color) !important;">
                                A matrícula é obrigatória
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorSetor" style="color: var(--text-color) !important;">
                                Setor/Departamento
                            </label>
                            <select id="colaboradorSetor" style="color: var(--text-color) !important; background-color: white !important;">
                                <option value="">Selecione um setor</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Elétrica">Elétrica</option>
                                <option value="Mecânica">Mecânica</option>
                                <option value="Almoxarifado">Almoxarifado</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Produção">Produção</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="colaboradorCargo" style="color: var(--text-color) !important;">
                                Cargo/Função
                            </label>
                            <input type="text" id="colaboradorCargo" maxlength="100" 
                                   placeholder="Ex: Técnico de Manutenção" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="colaboradorTelefone" style="color: var(--text-color) !important;">
                                Telefone
                            </label>
                            <input type="text" id="colaboradorTelefone" maxlength="20" 
                                   placeholder="Ex: (11) 99999-9999" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                        <div class="form-group">
                            <label for="colaboradorEmail" style="color: var(--text-color) !important;">
                                Email
                            </label>
                            <input type="email" id="colaboradorEmail" maxlength="100" 
                                   placeholder="Ex: joao@empresa.com" 
                                   style="color: var(--text-color) !important; background-color: white !important;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="colaboradorObservacoes" style="color: var(--text-color) !important;">
                            Observações
                        </label>
                        <textarea id="colaboradorObservacoes" rows="2" maxlength="500" 
                                  placeholder="Observações sobre o colaborador..." 
                                  style="color: var(--text-color) !important; background-color: white !important;"></textarea>
                    </div>
                    
                    <input type="hidden" id="colaboradorId">
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" id="salvarColaboradorBtn">
                            <i class="fas fa-save"></i> Salvar Colaborador
                        </button>
                        <button type="button" class="btn btn-warning" id="limparColaboradorBtn">
                            <i class="fas fa-eraser"></i> Limpar Formulário
                        </button>
                        <button type="button" class="btn btn-danger" id="excluirColaboradorBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Excluir Colaborador
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Área para atribuição de ferramentas -->
        <div class="card">
            <h3 class="card-title" style="color: var(--primary-color) !important;">
                <i class="fas fa-tools"></i> Atribuir Ferramentas
            </h3>
            
            <div id="atribuicaoContainer" style="display: none;">
                <div class="form-group">
                    <label style="color: var(--text-color) !important;">Colaborador Selecionado:</label>
                    <div style="background-color: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <strong id="colaboradorSelecionadoNome" style="color: var(--primary-color) !important;">
                            Nenhum
                        </strong> - 
                        <span id="colaboradorSelecionadoMatricula" style="color: var(--text-color) !important;">
                            Nenhum
                        </span> |
                        <span id="colaboradorFerramentasAtuais" style="color: var(--text-color) !important;">
                            0 ferramentas atribuídas
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ferramentaParaAtribuir" style="color: var(--text-color) !important;">
                        Selecionar Ferramenta para Atribuir:
                    </label>
                    <select id="ferramentaParaAtribuir" class="form-control" 
                            style="color: var(--text-color) !important; background-color: white !important;">
                        <option value="">Selecione uma ferramenta</option>
                        <!-- Opções serão preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dataAtribuicao" style="color: var(--text-color) !important;">
                        Data de Atribuição
                    </label>
                    <input type="date" id="dataAtribuicao" class="form-control" value="" 
                           style="color: var(--text-color) !important; background-color: white !important;">
                </div>
                
                <div class="form-group">
                    <label for="observacaoAtribuicao" style="color: var(--text-color) !important;">
                        Observação da Atribuição
                    </label>
                    <textarea id="observacaoAtribuicao" rows="2" maxlength="500" 
                              placeholder="Observação sobre esta atribuição..." class="form-control"
                              style="color: var(--text-color) !important; background-color: white !important;"></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="atribuirFerramentaBtn">
                        <i class="fas fa-link"></i> Atribuir Ferramenta
                    </button>
                    <button type="button" class="btn btn-warning" id="limparAtribuicaoBtn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
            
            <div id="semColaboradorSelecionado" style="text-align: center; padding: 20px;">
                <i class="fas fa-user" style="font-size: 40px; color: var(--gray-color); margin-bottom: 10px;"></i>
                <p style="color: var(--text-color) !important;">
                    Selecione um colaborador na lista acima para atribuir ferramentas
                </p>
            </div>
        </div>
    </div>
    
    <!-- Modal para visualizar ferramentas do colaborador -->
    <div id="ferramentasColaboradorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--primary-color) !important;">
                    Ferramentas do Colaborador
                </h3>
                <button class="modal-close" id="closeFerramentasModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="ferramentasColaboradorBody">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
        </div>
    </div>
</div>
            
            <!-- Mapeamento Tab (NOVO) -->
            <div id="mapeamento" class="tab-content">
                <h2 class="section-title"><i class="fas fa-map"></i> Mapeamento de Containers e Locais</h2>
                
                <div class="mapping-container">
                    <!-- Container de Ferramentas Elétricas (Mapa) -->
<div class="mapping-card" data-id="container_eletrico">
    <img src="mapa_container_eletrico_mini.png" 
         alt="Container de Ferramentas Elétricas" 
         class="mapping-thumbnail" 
         onclick="viewMapDetails('container_eletrico')"
         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiByeD0iOCIgZmlsbD0iI0UzRThGRCIvPgo8dGV4dCB4PSI1MCUiIHk9IjQ1JSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMzQ5OERCIj5NYXBhPC90ZXh0Pgo8dGV4dCB4PSI1MCUiIHk9IjYwJSIgdGV4dC1hbmNob3I9Im1pZGdsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMkMzRTUwIj5Db250YWluZXIgRWzDqXRyaWNhczwvdGV4dD4KPC9zdmc+'">
    
    <h3>Container de Ferramentas Elétricas</h3>
    <p>Mapa de organização interna com todas as posições identificadas.</p>
    <div class="mapping-stats">
        <div class="mapping-stat">
            <div class="mapping-stat-value">4</div>
            <div class="mapping-stat-label">Prateleiras L</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">10</div>
            <div class="mapping-stat-label">Prateleiras R</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">70</div>
            <div class="mapping-stat-label">Posições</div>
        </div>
    </div>
    <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('container_eletrico')">
        <i class="fas fa-search-plus"></i> Visualizar Mapa Completo
    </button>
</div>
                    
                    <!-- Outros containers podem ser adicionados aqui -->
                    <div class="mapping-card" data-id="container_mecanica">
                        <div class="no-image-placeholder" style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; background-color: #f5f5f5; border-radius: 8px; margin-bottom: 15px; cursor: pointer;" onclick="viewMapDetails('container_mecanica')">
                            <i class="fas fa-tools" style="color: #ccc; font-size: 60px;"></i>
                        </div>
                        <h3>Container de Mecânica</h3>
                        <p>Mapa de ferramentas manuais e equipamentos mecânicos.</p>
                        <div class="mapping-stats">
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Prateleiras</div>
                            </div>
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Posições</div>
                            </div>
                            <div class="mapping-stat">
                                <div class="mapping-stat-value">--</div>
                                <div class="mapping-stat-label">Itens</div>
                            </div>
                        </div>
                        <button class="btn btn-warning" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('container_mecanica')">
                            <i class="fas fa-plus-circle"></i> Adicionar Mapa
                        </button>
                    </div>
                    
                    <div class="mapping-card" data-id="almoxarifado_central">
    <img src="mapa_almoxarifado_central_mini.png" 
         alt="Almoxarifado Central" 
         class="mapping-thumbnail" 
         onclick="viewMapDetails('almoxarifado_central')"
         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiByeD0iOCIgZmlsbD0iI0UzRThGRCIvPgo8dGV4dCB4PSI1MCUiIHk9IjQ1JSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMzQ5OERCIj5NYXBhPC90ZXh0Pgo8dGV4dCB4PSI1MCUiIHk9IjYwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMkMzRTUwIj5BbW94YXJpZmFkbyBDZW50cmFsPC90ZXh0Pgo8L3N2Zz4+">
    <h3>Almoxarifado Central</h3>
    <p>Mapa de organização do almoxarifado principal (10.4m/34ft).</p>
    <div class="mapping-stats">
        <div class="mapping-stat">
            <div class="mapping-stat-value">5</div>
            <div class="mapping-stat-label">Seções (A-E)</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">15</div>
            <div class="mapping-stat-label">Ruas (A-H)</div>
        </div>
        <div class="mapping-stat">
            <div class="mapping-stat-value">70+</div>
            <div class="mapping-stat-label">Posições</div>
        </div>
    </div>
    <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="viewMapDetails('almoxarifado_central')">
        <i class="fas fa-search-plus"></i> Visualizar Mapa Completo
    </button>
</div>
                </div>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> Sobre o Mapeamento</h3>
                    <p>O sistema de mapeamento permite visualizar a organização física dos itens em containers e almoxarifados. Cada mapa mostra a disposição das prateleiras e as posições específicas onde os itens devem ser armazenados.</p>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="addNewMap()">
                            <i class="fas fa-plus"></i> Adicionar Novo Mapa
                        </button>
                        
                        <button class="btn btn-danger" onclick="downloadMapPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar/Baixar PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Exportar Tab -->
            <div id="exportar" class="tab-content">
                <h2 class="section-title"><i class="fas fa-file-excel"></i> Exportar Dados</h2>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-download"></i> Exportar Dados</h3>
                    <p style="margin-bottom: 20px;">Exporte todos os itens cadastrados para um arquivo Excel. O arquivo incluirá todas as informações.</p>
                    
                    <div class="form-group">
                        <label for="exportRange">Exportar</label>
                        <select id="exportRange" class="form-control">
                            <option value="all">Todos os itens</option>
                            <option value="available">Apenas disponíveis</option>
                            <option value="inuse">Apenas em uso</option>
                            <option value="maintenance">Apenas em manutenção</option>
                            <option value="lowstock">Apenas estoque baixo</option>
                        </select>
                    </div>
                    
                    <div class="loader" id="exportLoader"></div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="button" class="btn btn-success" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </button>
                        <button type="button" class="btn btn-primary" id="exportCSVBtn">
                            <i class="fas fa-file-csv"></i> Exportar para CSV
                        </button>
                        <button type="button" class="btn backup-btn" id="exportJSONBtn">
                            <i class="fas fa-file-code"></i> Exportar para JSON
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-history"></i> Histórico de Exportações</h3>
                    <div class="export-history" id="exportHistory">
                        <p style="text-align: center; color: var(--gray-color); padding: 20px 0;">
                            Nenhuma exportação realizada ainda
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Banco de Dados Online Tab -->
            <div id="database" class="tab-content">
                <h2 class="section-title"><i class="fas fa-database"></i> Banco de Dados Online</h2>
                
                <div class="config-container">
                    <div class="storage-status">
                        <div class="status-indicator" id="dbStatusIndicator"></div>
                        <h3 id="dbStatusText">Status: <span id="connectionStatus">Verificando...</span></h3>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-cloud"></i> Configuração Automática</h4>
                        <div class="step-content">
                            <div class="form-group">
                                <label>URL do Projeto</label>
                                <div style="background-color: #f5f5f5; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    <strong>https://azlgjkjzitbolyfyyaip.supabase.co</strong>
                                    <p style="margin-top: 5px; font-size: 12px; color: var(--gray-color);">
                                        Configurada automaticamente no sistema
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Chave da API</label>
                                <div style="background-color: #f5f5f5; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    <strong>Configuração Automática</strong>
                                    <p style="margin-top: 5px; font-size: 12px; color: var(--gray-color);">
                                        Conexão automática com o banco de dados corporativo
                                    </p>
                                </div>
                            </div>
                            
                            <p style="margin-top: 15px; color: var(--success-color);">
                                <i class="fas fa-check-circle"></i> O sistema conecta automaticamente ao banco de dados ao iniciar.
                            </p>
                        </div>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-sync-alt"></i> Sincronização</h4>
                        <div class="step-content">
                            <p>Gerencie a sincronização dos dados com a nuvem:</p>
                            <div class="btn-group">
                                <button type="button" class="btn btn-success" id="syncToOnlineBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Enviar para Nuvem
                                </button>
                                <button type="button" class="btn btn-primary" id="syncFromOnlineBtn2">
                                    <i class="fas fa-cloud-download-alt"></i> Buscar da Nuvem
                                </button>
                                <button type="button" class="btn btn-warning" id="syncBothBtn">
                                    <i class="fas fa-exchange-alt"></i> Sincronizar Ambos
                                </button>
                            </div>
                            
                            <div class="storage-info" style="margin-top: 15px;">
                                <p><strong>Configuração de Sincronização:</strong></p>
                                <div class="form-group">
                                    <label for="syncLimit">Limite de itens por sincronização:</label>
                                    <select id="syncLimit" class="form-control">
                                        <option value="50">50 itens</option>
                                        <option value="100" selected>100 itens</option>
                                        <option value="200">200 itens</option>
                                        <option value="500">500 itens</option>
                                        <option value="0">Todos (não recomendado)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-step">
                        <h4 class="step-title"><i class="fas fa-info-circle"></i> Status da Conexão</h4>
                        <div class="step-content">
                            <div id="connectionDetails">
                                <p><strong>Status atual:</strong> <span id="currentConnectionStatus">Verificando...</span></p>
                                <p><strong>Modo de operação:</strong> <span id="operationMode">Local</span></p>
                                <p><strong>Última sincronização:</strong> <span id="lastSyncTime">Nunca</span></p>
                                <p><strong>Itens locais:</strong> <span id="localItemsCount">0</span></p>
                                <p><strong>Itens na nuvem:</strong> <span id="cloudItemsCount">Carregando...</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal para visualizar item -->
        <div id="toolModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Detalhes do Item</h3>
                    <button class="modal-close" id="closeModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="toolModalBody">
                    <!-- Conteúdo do modal será preenchido via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Modal QR Code -->
        <div id="qrModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">QR Code do Item</h3>
                    <button class="modal-close" id="closeQRModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="qrModalBody">
                    <!-- QR Code será gerado aqui -->
                </div>
            </div>
        </div>
        
        <!-- Modal para Mapa -->
        <div id="mapModal" class="modal">
            <div class="modal-content" style="max-width: 1200px;">
                <div class="modal-header">
                    <h3 class="modal-title">Mapa do Container</h3>
                    <button class="modal-close" id="closeMapModalBtn">&times;</button>
                </div>
                <div class="modal-body" id="mapModalBody">
                    <!-- Conteúdo do mapa será preenchido via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Input para upload de imagem (oculto) -->
        <input type="file" id="imageUploadInput" accept="image/*" capture="environment" style="display: none;">
        
        <!-- Input para restaurar backup (oculto) -->
        <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <p>Desenvolvido por Fábio Mendes Rodrigues, Planejador da F.W. Company</p>
            <p class="footer-version">Versão 2.0_rev05 | Última atualização: <span id="currentDate"></span></p>
        </div>
    </footer>

    <!-- Botão de Enviar para Nuvem Fixo -->
    <button class="cloud-upload-btn" id="fixedCloudUploadBtn" style="display: none;">
        <i class="fas fa-cloud-upload-alt"></i> Enviar para a Nuvem
    </button>

    <script>
        // ============================================
        // CONFIGURAÇÃO FIXA DO SUPABASE
        // ============================================

        // Credenciais do seu projeto Supabase
        const FIXED_SUPABASE_CONFIG = {
            url: 'https://azlgjkjzitbolyfyyaip.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6bGdqa2p6aXRib2x5Znl5YWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTQ1NjcsImV4cCI6MjA4MTk5MDU2N30.PefjFNb5Phq2ZkR26-RlJdb-pnFUbYp1PxjYwI1LUpA'
        };

        // ============================================
        // SISTEMA DE AUTENTICAÇÃO E GERENCIAMENTO
        // ============================================

        // Dados de usuários
        const users = {
            'fabio@fwcompany.com.br': {
                password: 'FabioFW123@',
                role: 'dev',
                name: 'Fábio Mendes',
                email: 'fabio@fwcompany.com.br'
            },
            'emerson.silva@fwcompany.com.br': {
                password: 'EmersonFW1@',
                role: 'almoxarife',
                name: 'Emerson Silva',
                email: 'emerson.silva@fwcompany.com.br'
            },
            'fwuser': {
                password: 'User123',
                role: 'user',
                name: 'Usuário Genérico',
                email: 'fwuser@fwcompany.com.br'
            },
            'raquel@fwcompany.com.br': {
                password: 'RaqueL1234',
                role: 'user',
                name: 'Raquel',
                email: 'raquel@fwcompany.com.br'
            }
        };

        // Estado da aplicação
        let currentUser = null;
        let tools = [];
        let currentToolImage = null;
        let chartInstance = null;
        let isEditing = false;
        let editingToolId = null;
        let supabaseClient = null;
        let isOnlineMode = false;
        let currentStorageType = 'localStorage';
        let lastSyncTime = null;
        let currentStatusFilter = 'all';

        // ============================================
        // SISTEMA DE COLABORADORES
        // ============================================

        // Array para armazenar colaboradores
        let colaboradores = [];
        let isEditingColaborador = false;
        let currentColaboradorId = null;
        let colaboradorSelecionado = null;

        // Dados de exemplo para colaboradores
        function getExampleColaboradores() {
            return [
                {
                    id: 1,
                    nome: 'João da Silva',
                    matricula: 'MAT-001',
                    setor: 'Manutenção',
                    cargo: 'Técnico de Manutenção',
                    telefone: '(11) 99999-9999',
                    email: 'joao@empresa.com',
                    observacoes: 'Colaborador dedicado e cuidadoso com ferramentas',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    usuarioCadastro: 'Sistema',
                    ferramentasAtribuidas: [] // Array de IDs de ferramentas atribuídas
                },
                {
                    id: 2,
                    nome: 'Maria Santos',
                    matricula: 'MAT-002',
                    setor: 'Elétrica',
                    cargo: 'Eletricista',
                    telefone: '(11) 98888-8888',
                    email: 'maria@empresa.com',
                    observacoes: 'Especialista em instalações elétricas',
                    dataCadastro: new Date().toISOString().split('T')[0],
                    usuarioCadastro: 'Sistema',
                    ferramentasAtribuidas: []
                }
            ];
        }

        // Array para histórico de atribuições
        let historicoAtribuicoes = [];

        // ============================================
        // FUNÇÕES DE COLABORADORES
        // ============================================

        // ============================================
        // FUNÇÃO AUXILIAR: Verificar se ferramenta está atribuída
        // ============================================

        function isToolAssigned(toolId) {
            if (!colaboradores || !Array.isArray(colaboradores)) return false;
    
            for (const colaborador of colaboradores) {
                if (colaborador.ferramentasAtribuidas && 
                Array.isArray(colaborador.ferramentasAtribuidas) && 
                colaborador.ferramentasAtribuidas.includes(toolId)) {
                return true;
            }
        }
        return false;
    }


        // Carregar colaboradores do localStorage
        function loadColaboradores() {
            try {
                const saved = localStorage.getItem('colaboradores');
                if (saved) {
                    colaboradores = JSON.parse(saved);
                } else {
                    colaboradores = getExampleColaboradores();
                    saveColaboradores();
                }
                
                // Carregar histórico de atribuições
                const savedHistorico = localStorage.getItem('historicoAtribuicoes');
                if (savedHistorico) {
                    historicoAtribuicoes = JSON.parse(savedHistorico);
                }
                
            } catch (error) {
                console.error('Erro ao carregar colaboradores:', error);
                colaboradores = getExampleColaboradores();
            }
        }

        // Salvar colaboradores no localStorage
        function saveColaboradores() {
            try {
                localStorage.setItem('colaboradores', JSON.stringify(colaboradores));
                localStorage.setItem('historicoAtribuicoes', JSON.stringify(historicoAtribuicoes));
                return true;
            } catch (error) {
                console.error('Erro ao salvar colaboradores:', error);
                return false;
            }
        }

        // Validar formulário de colaborador
        function validateColaboradorForm() {
            let isValid = true;
            
            const nome = document.getElementById('colaboradorNome').value.trim();
            const matricula = document.getElementById('colaboradorMatricula').value.trim();
            
            // Limpar erros
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Validar campos obrigatórios
            if (!nome) {
                document.getElementById('colaboradorNome').classList.add('error');
                document.getElementById('colaboradorNomeError').style.display = 'block';
                isValid = false;
            }
            
            if (!matricula) {
                document.getElementById('colaboradorMatricula').classList.add('error');
                document.getElementById('colaboradorMatriculaError').style.display = 'block';
                isValid = false;
            } else if (isEditingColaborador) {
                if (colaboradores.some(c => c.matricula === matricula && c.id !== currentColaboradorId)) {
                    document.getElementById('colaboradorMatricula').classList.add('error');
                    document.getElementById('colaboradorMatriculaError').textContent = 'Já existe um colaborador com esta matrícula';
                    document.getElementById('colaboradorMatriculaError').style.display = 'block';
                    isValid = false;
                }
            } else {
                if (colaboradores.some(c => c.matricula === matricula)) {
                    document.getElementById('colaboradorMatricula').classList.add('error');
                    document.getElementById('colaboradorMatriculaError').textContent = 'Já existe um colaborador com esta matrícula';
                    document.getElementById('colaboradorMatriculaError').style.display = 'block';
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Salvar colaborador
        async function saveColaborador() {
            if (!validateColaboradorForm()) {
                showNotification('Preencha todos os campos obrigatórios!', 'error');
                return false;
            }
            
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para salvar colaboradores.', 'error');
                return false;
            }
            
            try {
                const colaboradorData = getColaboradorFormData();
                
                if (isEditingColaborador && currentColaboradorId) {
                    await updateColaborador(currentColaboradorId, colaboradorData);
                } else {
                    await createColaborador(colaboradorData);
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                showNotification('Erro ao salvar colaborador.', 'error');
                return false;
            }
        }

        // Obter dados do formulário de colaborador
        function getColaboradorFormData() {
            const usuario = currentUser ? currentUser.name : 'Sistema';
            
            return {
                nome: document.getElementById('colaboradorNome').value.trim(),
                matricula: document.getElementById('colaboradorMatricula').value.trim(),
                setor: document.getElementById('colaboradorSetor').value,
                cargo: document.getElementById('colaboradorCargo').value.trim(),
                telefone: document.getElementById('colaboradorTelefone').value.trim(),
                email: document.getElementById('colaboradorEmail').value.trim(),
                observacoes: document.getElementById('colaboradorObservacoes').value.trim(),
                dataCadastro: new Date().toISOString().split('T')[0],
                usuarioCadastro: usuario,
                ferramentasAtribuidas: isEditingColaborador ? 
                    (colaboradores.find(c => c.id === currentColaboradorId)?.ferramentasAtribuidas || []) : []
            };
        }

        // Criar novo colaborador
        async function createColaborador(colaboradorData) {
            const newColaborador = {
                id: Date.now(),
                ...colaboradorData,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            colaboradores.push(newColaborador);
            
            await saveColaboradores();
            
            updateColaboradoresList();
            showNotification('Colaborador cadastrado com sucesso!', 'success');
            clearColaboradorForm();
        }

        // Atualizar colaborador existente
        async function updateColaborador(colaboradorId, colaboradorData) {
            const colaboradorIndex = colaboradores.findIndex(c => c.id === colaboradorId);
            
            if (colaboradorIndex === -1) {
                showNotification('Colaborador não encontrado!', 'error');
                return false;
            }
            
            // Manter ferramentas atribuídas
            const ferramentasAtribuidas = colaboradores[colaboradorIndex].ferramentasAtribuidas || [];
            
            const updatedColaborador = {
                ...colaboradores[colaboradorIndex],
                ...colaboradorData,
                ferramentasAtribuidas: ferramentasAtribuidas,
                updatedAt: new Date().toISOString()
            };
            
            colaboradores[colaboradorIndex] = updatedColaborador;
            
            await saveColaboradores();
            
            updateColaboradoresList();
            showNotification('Colaborador atualizado com sucesso!', 'success');
            clearColaboradorForm();
            
            return true;
        }

        // Limpar formulário de colaborador
        function clearColaboradorForm() {
            document.getElementById('colaboradorForm').reset();
            document.getElementById('colaboradorId').value = '';
            document.getElementById('excluirColaboradorBtn').style.display = 'none';
            isEditingColaborador = false;
            currentColaboradorId = null;
            document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Colaborador';
        }

        // Editar colaborador
        function editColaborador(colaboradorId) {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para editar colaboradores.', 'error');
                return;
            }
            
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) return;
            
            // Preencher formulário
            document.getElementById('colaboradorNome').value = colaborador.nome;
            document.getElementById('colaboradorMatricula').value = colaborador.matricula;
            document.getElementById('colaboradorSetor').value = colaborador.setor || '';
            document.getElementById('colaboradorCargo').value = colaborador.cargo || '';
            document.getElementById('colaboradorTelefone').value = colaborador.telefone || '';
            document.getElementById('colaboradorEmail').value = colaborador.email || '';
            document.getElementById('colaboradorObservacoes').value = colaborador.observacoes || '';
            document.getElementById('colaboradorId').value = colaborador.id;
            
            isEditingColaborador = true;
            currentColaboradorId = colaboradorId;
            
            document.getElementById('salvarColaboradorBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Colaborador';
            document.getElementById('excluirColaboradorBtn').style.display = 'inline-flex';
            
            showNotification('Editando colaborador. Atualize os dados.', 'warning');
        }

        // Excluir colaborador
        async function deleteColaborador(colaboradorId) {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para excluir colaboradores.', 'error');
                return;
            }
            
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) {
                showNotification('Colaborador não encontrado!', 'error');
                return;
            }
            
            // Verificar se tem ferramentas atribuídas
            if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
                if (!confirm('Este colaborador tem ferramentas atribuídas. Deseja realmente excluir? As ferramentas serão marcadas como disponíveis.')) {
                    return;
                }
                
                // Remover atribuição das ferramentas
                colaborador.ferramentasAtribuidas.forEach(toolId => {
                    const toolIndex = tools.findIndex(t => t.id === toolId);
                    if (toolIndex !== -1) {
                        tools[toolIndex].status = 'Disponível';
                        // Remover do histórico
                        historicoAtribuicoes = historicoAtribuicoes.filter(h => 
                            !(h.colaboradorId === colaboradorId && h.toolId === toolId && !h.dataDevolucao)
                        );
                    }
                });
                
                await saveTools();
                await saveColaboradores();
            }
            
            // Remover colaborador
            colaboradores = colaboradores.filter(c => c.id !== colaboradorId);
            await saveColaboradores();
            
            // Se era o colaborador selecionado, limpar seleção
            if (colaboradorSelecionado && colaboradorSelecionado.id === colaboradorId) {
                colaboradorSelecionado = null;
                updateAtribuicaoUI();
            }
            
            updateColaboradoresList();
            showNotification('Colaborador excluído com sucesso!', 'success');
            clearColaboradorForm();
        }

        // Atualizar lista de colaboradores
        function updateColaboradoresList(searchTerm = '') {
            const tbody = document.getElementById('colaboradoresTableBody');
            const noColaboradoresRow = document.getElementById('noColaboradoresRow');
            
            tbody.innerHTML = '';
            tbody.appendChild(noColaboradoresRow);
            
            let filteredColaboradores = colaboradores;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredColaboradores = colaboradores.filter(colaborador => 
                    colaborador.nome.toLowerCase().includes(term) ||
                    colaborador.matricula.toLowerCase().includes(term) ||
                    (colaborador.setor && colaborador.setor.toLowerCase().includes(term)) ||
                    (colaborador.cargo && colaborador.cargo.toLowerCase().includes(term))
                );
            }
            
            if (filteredColaboradores.length === 0) {
                noColaboradoresRow.style.display = 'table-row';
                noColaboradoresRow.innerHTML = `<td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-color);">
                    Nenhum colaborador encontrado${searchTerm ? ' para "' + searchTerm + '"' : ''}
                </td>`;
                return;
            }
            
            noColaboradoresRow.style.display = 'none';
            
            filteredColaboradores.forEach(colaborador => {
                const row = document.createElement('tr');
                row.innerHTML = createColaboradorTableRow(colaborador);
                tbody.appendChild(row);
            });
            
            addColaboradorRowEventListeners();
        }

        // Criar linha da tabela de colaboradores
        function createColaboradorTableRow(colaborador) {
            const ferramentasCount = colaborador.ferramentasAtribuidas ? colaborador.ferramentasAtribuidas.length : 0;
            const statusClass = ferramentasCount > 0 ? 'status-ontrack' : 'status-completed';
            const statusText = ferramentasCount > 0 ? `${ferramentasCount} ferramentas` : 'Sem ferramentas';
            
            // Verificar permissões para ações
            const canEdit = currentUser.role !== 'user';
            
            return `
                <td><strong>${colaborador.nome}</strong></td>
                <td>${colaborador.matricula}</td>
                <td>${colaborador.setor || '-'}</td>
                <td>${colaborador.cargo || '-'}</td>
                <td>${colaborador.telefone || '-'}</td>
                <td>${colaborador.email || '-'}</td>
                <td>${ferramentasCount}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" data-id="${colaborador.id}" title="Visualizar ferramentas">
                            <i class="fas fa-tools"></i>
                        </button>
                        <button class="action-btn action-btn-view" data-id="${colaborador.id}" title="Selecionar para atribuição">
                            <i class="fas fa-user-check"></i>
                        </button>
                        ${canEdit ? `
                            <button class="action-btn action-btn-edit" data-id="${colaborador.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-btn-delete" data-id="${colaborador.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
        }

        // Adicionar event listeners às linhas de colaboradores
        function addColaboradorRowEventListeners() {
            // Botão para visualizar ferramentas
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                if (btn.querySelector('.fa-tools')) {
                    btn.addEventListener('click', function() {
                        const colaboradorId = parseInt(this.getAttribute('data-id'));
                        viewColaboradorFerramentas(colaboradorId);
                    });
                }
            });
            
            // Botão para selecionar para atribuição
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                if (btn.querySelector('.fa-user-check')) {
                    btn.addEventListener('click', function() {
                        const colaboradorId = parseInt(this.getAttribute('data-id'));
                        selectColaboradorForAtribuicao(colaboradorId);
                    });
                }
            });
            
            // Botão para editar colaborador
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const colaboradorId = parseInt(this.getAttribute('data-id'));
                    editColaborador(colaboradorId);
                });
            });
            
            // Botão para excluir colaborador
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const colaboradorId = parseInt(this.getAttribute('data-id'));
                    deleteColaborador(colaboradorId);
                });
            });
        }

        // Visualizar ferramentas do colaborador
        function viewColaboradorFerramentas(colaboradorId) {
            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) return;
            
            const modalBody = document.getElementById('ferramentasColaboradorBody');
            
            let ferramentasHTML = '';
            
            if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
                ferramentasHTML = `
                    <h4 style="margin-bottom: 20px;">${colaborador.nome} - Ferramentas Atribuídas</h4>
                    <div class="tools-list">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Data Atribuição</th>
                                        <th>Observação</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                colaborador.ferramentasAtribuidas.forEach(toolId => {
                    const tool = tools.find(t => t.id === toolId);
                    if (tool) {
                        const atribuicao = historicoAtribuicoes.find(h => 
                            h.colaboradorId === colaboradorId && 
                            h.toolId === toolId && 
                            !h.dataDevolucao
                        );
                        
                        ferramentasHTML += `
                            <tr>
                                <td><strong>${tool.code}</strong></td>
                                <td>${tool.name}</td>
                                <td>${tool.category}</td>
                                <td>${atribuicao ? formatDate(atribuicao.dataAtribuicao) : '-'}</td>
                                <td>${atribuicao && atribuicao.observacao ? atribuicao.observacao : '-'}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-view" onclick="viewToolDetails(${tool.id})" title="Ver detalhes">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn action-btn-danger" onclick="devolverFerramenta(${colaboradorId}, ${tool.id})" title="Devolver ferramenta">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                ferramentasHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                ferramentasHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-tools" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                        <h3>Nenhuma ferramenta atribuída</h3>
                        <p>Este colaborador não possui ferramentas atribuídas no momento.</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = ferramentasHTML;
            document.getElementById('ferramentasColaboradorModal').style.display = 'flex';
        }

        // Devolver ferramenta do colaborador (CORRIGIDA)
async function devolverFerramenta(colaboradorId, toolId) {
    // Verificar permissão
    if (currentUser.role === 'user') {
        showNotification('Usuário não tem permissão para devolver ferramentas.', 'error');
        return;
    }
    
    const colaborador = colaboradores.find(c => c.id === colaboradorId);
    const tool = tools.find(t => t.id === toolId);
    
    if (!colaborador || !tool) {
        showNotification('Colaborador ou ferramenta não encontrada!', 'error');
        return;
    }
    
    if (!confirm(`Devolver "${tool.name}" do colaborador ${colaborador.nome}?`)) {
        return;
    }
    
    try {
        // Atualizar status da ferramenta para "Disponível"
        tool.status = 'Disponível';
        
        // Remover ferramenta da lista do colaborador
        colaborador.ferramentasAtribuidas = colaborador.ferramentasAtribuidas.filter(id => id !== toolId);
        
        // Atualizar histórico de atribuições
        const atribuicaoIndex = historicoAtribuicoes.findIndex(h => 
            h.colaboradorId === colaboradorId && 
            h.toolId === toolId && 
            !h.dataDevolucao
        );
        
        if (atribuicaoIndex !== -1) {
            historicoAtribuicoes[atribuicaoIndex].dataDevolucao = new Date().toISOString().split('T')[0];
            historicoAtribuicoes[atribuicaoIndex].usuarioDevolucao = currentUser.name;
        }
        
        // Salvar alterações
        await saveTools();
        await saveColaboradores();
        
        // Atualizar interfaces
        updateColaboradoresList();
        updateAtribuicaoUI();
        loadToolsList(currentStatusFilter); // Atualiza lista de ferramentas
        loadFerramentasDisponiveis(); // Atualiza lista de disponíveis
        
        // Fechar modal se estiver aberto
        document.getElementById('ferramentasColaboradorModal').style.display = 'none';
        
        showNotification(`Ferramenta "${tool.name}" devolvida com sucesso!`, 'success');
        
    } catch (error) {
        console.error('Erro ao devolver ferramenta:', error);
        showNotification('Erro ao devolver ferramenta.', 'error');
    }
}

        // Selecionar colaborador para atribuição
        function selectColaboradorForAtribuicao(colaboradorId) {
            colaboradorSelecionado = colaboradores.find(c => c.id === colaboradorId);
            
            if (!colaboradorSelecionado) {
                showNotification('Colaborador não encontrado!', 'error');
                return;
            }
            
            updateAtribuicaoUI();
            loadFerramentasDisponiveis();
        }

        // Atualizar interface de atribuição
        function updateAtribuicaoUI() {
            const atribuicaoContainer = document.getElementById('atribuicaoContainer');
            const semColaborador = document.getElementById('semColaboradorSelecionado');
            
            if (colaboradorSelecionado) {
                atribuicaoContainer.style.display = 'block';
                semColaborador.style.display = 'none';
                
                document.getElementById('colaboradorSelecionadoNome').textContent = colaboradorSelecionado.nome;
                document.getElementById('colaboradorSelecionadoMatricula').textContent = colaboradorSelecionado.matricula;
                
                const ferramentasCount = colaboradorSelecionado.ferramentasAtribuidas ? colaboradorSelecionado.ferramentasAtribuidas.length : 0;
                document.getElementById('colaboradorFerramentasAtuais').textContent = `${ferramentasCount} ferramentas atribuídas`;
                
                // Verificar limite de 20 ferramentas
                if (ferramentasCount >= 20) {
                    document.getElementById('atribuirFerramentaBtn').disabled = true;
                    document.getElementById('atribuirFerramentaBtn').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Limite Atingido (20)';
                    showNotification('Este colaborador já atingiu o limite de 20 ferramentas!', 'warning');
                } else {
                    document.getElementById('atribuirFerramentaBtn').disabled = false;
                    document.getElementById('atribuirFerramentaBtn').innerHTML = '<i class="fas fa-link"></i> Atribuir Ferramenta';
                }
                
            } else {
                atribuicaoContainer.style.display = 'none';
                semColaborador.style.display = 'block';
            }
            
            // Configurar data atual
            document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
        }

        // Carregar ferramentas disponíveis para atribuição (CORRIGIDA)
function loadFerramentasDisponiveis() {
    const select = document.getElementById('ferramentaParaAtribuir');
    select.innerHTML = '<option value="">Selecione uma ferramenta</option>';
    
    if (!colaboradorSelecionado) return;
    
    // Identificar quais ferramentas já estão atribuídas a QUALQUER colaborador
    const todasFerramentasAtribuidas = [];
    
    colaboradores.forEach(colaborador => {
        if (colaborador.ferramentasAtribuidas && colaborador.ferramentasAtribuidas.length > 0) {
            todasFerramentasAtribuidas.push(...colaborador.ferramentasAtribuidas);
        }
    });
    
    // Filtrar ferramentas:
    // 1. Que estão disponíveis OU em uso (porque se já está em uso, significa que está com alguém)
    // 2. E que NÃO estão atribuídas a nenhum colaborador atualmente
    tools
        .filter(tool => {
            // Verificar se a ferramenta NÃO está na lista de ferramentas atribuídas
            const naoAtribuida = !todasFerramentasAtribuidas.includes(tool.id);
            
            // Verificar se está disponível ou reservada (não em uso)
            const statusValido = tool.status === 'Disponível' || tool.status === 'Reservado';
            
            return naoAtribuida && statusValido;
        })
        .forEach(tool => {
            const option = document.createElement('option');
            option.value = tool.id;
            option.textContent = `${tool.code} - ${tool.name} (${tool.category}) | ${tool.status}`;
            select.appendChild(option);
        });
    
    // Se não houver ferramentas disponíveis
    if (select.options.length === 1) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Nenhuma ferramenta disponível para atribuição";
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
    }
}

        // Atribuir ferramenta ao colaborador
async function atribuirFerramenta() {
    // Verificar permissão
    if (currentUser.role === 'user') {
        showNotification('Usuário não tem permissão para atribuir ferramentas.', 'error');
        return;
    }
    
    if (!colaboradorSelecionado) {
        showNotification('Selecione um colaborador primeiro!', 'error');
        return;
    }
    
    const toolId = parseInt(document.getElementById('ferramentaParaAtribuir').value);
    const dataAtribuicao = document.getElementById('dataAtribuicao').value;
    const observacao = document.getElementById('observacaoAtribuicao').value.trim();
    
    if (!toolId) {
        showNotification('Selecione uma ferramenta!', 'error');
        return;
    }
    
    const tool = tools.find(t => t.id === toolId);
    if (!tool) {
        showNotification('Ferramenta não encontrada!', 'error');
        return;
    }
    
    // Verificar limite de 20 ferramentas
    const ferramentasCount = colaboradorSelecionado.ferramentasAtribuidas ? colaboradorSelecionado.ferramentasAtribuidas.length : 0;
    if (ferramentasCount >= 20) {
        showNotification('Este colaborador já atingiu o limite de 20 ferramentas!', 'error');
        return;
    }
    
    try {
        // Atualizar status da ferramenta
        tool.status = 'Em Uso';
        
        // Adicionar ferramenta à lista do colaborador
        if (!colaboradorSelecionado.ferramentasAtribuidas) {
            colaboradorSelecionado.ferramentasAtribuidas = [];
        }
        colaboradorSelecionado.ferramentasAtribuidas.push(toolId);
        
        // Adicionar ao histórico de atribuições
        const historicoItem = {
            id: Date.now(),
            colaboradorId: colaboradorSelecionado.id,
            colaboradorNome: colaboradorSelecionado.nome,
            toolId: toolId,
            toolNome: tool.name,
            toolCodigo: tool.code,
            dataAtribuicao: dataAtribuicao,
            observacao: observacao,
            usuarioAtribuicao: currentUser.name,
            dataDevolucao: null,
            usuarioDevolucao: null
        };
        
        historicoAtribuicoes.push(historicoItem);
        
        // Salvar alterações
        await saveTools();
        await saveColaboradores();
        
        // Atualizar interfaces
        updateColaboradoresList();
        updateAtribuicaoUI();
        loadToolsList(currentStatusFilter);
        
        // Limpar formulário de atribuição
        document.getElementById('ferramentaParaAtribuir').value = '';
        document.getElementById('observacaoAtribuicao').value = '';
        document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
        
        showNotification(`Ferramenta "${tool.name}" atribuída a ${colaboradorSelecionado.nome}!`, 'success');
        
    } catch (error) {
        console.error('Erro ao atribuir ferramenta:', error);
        showNotification('Erro ao atribuir ferramenta.', 'error');
    }
}

        // ============================================
        // SISTEMA DE VISUALIZAÇÃO DE IMAGEM AMPLIADA
        // ============================================

        // Função para visualizar imagem ampliada
        function viewEnlargedImage(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            // Verificar se a imagem existe
            if (!tool.image) {
                viewToolDetails(toolId);
                return;
            }
            
            // Remover qualquer modal de imagem existente
            const existingModal = document.querySelector('.image-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Criar modal para imagem ampliada
            const modal = document.createElement('div');
            modal.className = 'modal image-modal';
            
            modal.innerHTML = `
                <div style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.95);">
                    <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                        <button class="image-modal-close" id="closeImageModalBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(128, 128, 128, 0.7); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
    <i class="fas fa-times"></i>
</button>
                        <img src="${tool.image}" 
                             alt="${tool.name}" 
                             style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; cursor: pointer;">
                        <div class="image-caption">
                            <h4>${tool.name}</h4>
                            <p>${tool.code} | ${tool.category}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Fechar modal ao clicar no botão
            modal.querySelector('#closeImageModalBtn').addEventListener('click', function() {
                modal.remove();
            });
            
            // Fechar modal ao clicar fora da imagem
            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target.classList.contains('image-modal')) {
                    modal.remove();
                }
            });
            
            // Fechar com ESC
            const closeOnEsc = function(e) {
                if (e.key === 'Escape') {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            
            document.addEventListener('keydown', closeOnEsc);
        }






        // Adicionar event listeners para miniaturas
        function addThumbnailEventListeners() {
            // Remover event listeners anteriores para evitar duplicação
            document.querySelectorAll('.tool-thumbnail').forEach(img => {
                img.replaceWith(img.cloneNode(true));
            });
            
            // Para miniaturas com imagem
            document.querySelectorAll('.tool-thumbnail').forEach(img => {
                img.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = parseInt(this.getAttribute('data-id'));
                    viewEnlargedImage(toolId);
                });
            });
            
            // Para placeholders sem imagem
            document.querySelectorAll('.no-image-placeholder').forEach(placeholder => {
                placeholder.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolId = parseInt(this.getAttribute('data-id'));
                    viewToolDetails(toolId);
                });
            });
        }

        // Atualize a função addRowEventListeners para incluir as miniaturas:
        function addRowEventListeners() {
            // Adicionar eventos para as miniaturas primeiro
            addThumbnailEventListeners();
            
            // Depois os eventos existentes
            document.querySelectorAll('.action-btn-view').forEach(btn => {
                // Verificar se é botão de visualização (não QR code)
                if (!btn.title.includes('QR')) {
                    btn.addEventListener('click', function() {
                        const toolId = parseInt(this.getAttribute('data-id'));
                        viewToolDetails(toolId);
                    });
                }
            });
            
            document.querySelectorAll('.action-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const toolId = parseInt(this.getAttribute('data-id'));
                    editTool(toolId);
                });
            });
            
            document.querySelectorAll('.action-btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const toolId = parseInt(this.getAttribute('data-id'));
                    deleteTool(toolId);
                });
            });
        }

        // Função para baixar PDFs dos mapas
function downloadMapPDF() {
    // Criar modal de seleção
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--light-color); padding-bottom: 15px;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    <i class="fas fa-file-pdf"></i> Baixar Mapa em PDF
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: var(--gray-color); cursor: pointer;">
                    &times;
                </button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary-color);">
                    <i class="fas fa-map"></i> Selecione o mapa para baixar:
                </label>
                <select id="pdfMapSelector" style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; background: white; color: var(--text-color);">
                    <option value="">-- Selecione um mapa --</option>
                    <option value="container_eletrico">Container de Ferramentas Elétricas</option>
                    <option value="almoxarifado_central">Almoxarifado Central</option>
                </select>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid var(--warning-color);">
                <p style="margin: 0; color: var(--text-color); font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Os arquivos PDF serão baixados do servidor local.
                </p>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 15px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: var(--light-color); border: none; border-radius: 6px; color: var(--text-color); cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="confirmPDFDownload()" style="padding: 10px 20px; background: var(--danger-color); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-download"></i> Baixar PDF
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Fechar ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Função para confirmar e baixar o PDF
function confirmPDFDownload() {
    const selector = document.getElementById('pdfMapSelector');
    const selectedMap = selector.value;
    
    if (!selectedMap) {
        showNotification('Selecione um mapa primeiro!', 'error');
        return;
    }
    
    // Definir nomes dos arquivos PDF
    const pdfFiles = {
        'container_eletrico': 'Container de Ferramentas Elétricas (Mapa).pdf',
        'almoxarifado_central': 'Almoxarifado Central (Mapa).pdf'
    };
    
    const fileName = pdfFiles[selectedMap];
    
    // Remover o modal
    document.querySelector('.modal').remove();
    
    // Tentar baixar o arquivo
    try {
        // Criar link para download
        const link = document.createElement('a');
        link.href = fileName;
        link.download = fileName;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`Download iniciado: ${fileName}`, 'success');
        
    } catch (error) {
        console.error('Erro ao baixar PDF:', error);
        
        // Se falhar, mostrar mensagem de ajuda
        showNotification(`Arquivo não encontrado: ${fileName}`, 'error');
        
        // Mostrar ajuda
        setTimeout(() => {
            showNotification('Verifique se o arquivo PDF está na mesma pasta do sistema', 'warning');
        }, 1500);
    }
}

        // ============================================
        // FUNÇÕES PARA A ABA MAPEAMENTO
        // ============================================

        // Função para visualizar mapa completo
function viewMapDetails(mapId) {
    const mapModalBody = document.getElementById('mapModalBody');
    
    if (mapId === 'container_eletrico') {
        mapModalBody.innerHTML = `
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">
                <i class="fas fa-map-marked-alt"></i> Container de Ferramentas Elétricas - Mapa Completo
            </h3>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <p><strong>Dimensões:</strong> 2.35m / 7ft de altura</p>
                <p><strong>Organização:</strong> 4 prateleiras L (esquerda) + 10 prateleiras R (direita)</p>
                <p><strong>Total de posições:</strong> 70 posições identificadas (a-e em cada prateleira)</p>
                <p><strong>Data do Mapa:</strong> Última atualização: ${new Date().toLocaleDateString('pt-BR')}</p>
            </div>
            
            <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <!-- Mapa em imagem -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="position: relative; display: inline-block; max-width: 100%;">
                        <img id="mapImage" 
     src="mapa_container_eletrico.png"  // ← SEU NOME REAL AQUI
     alt="Mapa do Container de Ferramentas Elétricas" 
     style="max-width: 100%; max-height: 600px; border-radius: 8px; border: 2px solid var(--border-color); cursor: zoom-in;"
     onclick="zoomMapImage()"
     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgdmlld0JveD0iMCAwIDgwMCA2MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBmaWxsPSIjRjVGN0ZBIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iMzAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5NUE1QTYiPk1hcGEgbmFvIGNhcnJlZ2FkbzwvdGV4dD4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWxseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5NUE1QTYiPm1hcGFfY29udGFpbmVyX2VsZXRyaWNvLnBuZzwvdGV4dD4KPC9zdmc+';">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                            <i class="fas fa-search-plus"></i> Clique para ampliar
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: var(--gray-color); font-size: 14px;">
                        Clique na imagem para visualizar em tela cheia
                    </p>
                </div>
                
                <!-- Controles da imagem -->
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-primary" onclick="zoomInMap()">
                        <i class="fas fa-search-plus"></i> Aumentar Zoom
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="zoomOutMap()">
                        <i class="fas fa-search-minus"></i> Diminuir Zoom
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="resetMapZoom()">
                        <i class="fas fa-sync-alt"></i> Zoom Original
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="rotateMapImage()">
                        <i class="fas fa-redo"></i> Girar 90°
                    </button>
                </div>
                
                <!-- Legenda do Mapa -->
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="color: var(--primary-color); margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> Legenda do Mapa
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px;"></div>
                            <span><strong>L1-L4:</strong> Prateleiras Esquerda</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 4px;"></div>
                            <span><strong>R1-R10:</strong> Prateleiras Direita</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #e8f5e9; border: 1px solid #81c784; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">a-e</div>
                            <span><strong>Posições:</strong> Cada prateleira tem 5 posições (a,b,c,d,e)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background-color: #fff3e0; border: 1px solid #ffb74d; border-radius: 4px;"></div>
                            <span><strong>Zona de Acesso:</strong> Área para movimentação</span>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes da Organização -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <h5 style="color: var(--secondary-color); margin-bottom: 10px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;">
                            <i class="fas fa-layer-group"></i> Prateleiras L (Esquerda)
                        </h5>
                        <ul style="padding-left: 20px;">
                            <li><strong>L1:</strong> Ferramentas leves e acessórios</li>
                            <li><strong>L2:</strong> Equipamentos de medição</li>
                            <li><strong>L3:</strong> Ferramentas manuais especiais</li>
                            <li><strong>L4:</strong> Reserva e componentes</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h5 style="color: var(--secondary-color); margin-bottom: 10px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;">
                            <i class="fas fa-layer-group"></i> Prateleiras R (Direita)
                        </h5>
                        <ul style="padding-left: 20px;">
                            <li><strong>R1-R3:</strong> Ferramentas elétricas principais</li>
                            <li><strong>R4-R6:</strong> Equipamentos à bateria</li>
                            <li><strong>R7-R8:</strong> Máquinas estacionárias</li>
                            <li><strong>R9-R10:</strong> Acessórios e consumíveis</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Botões de Ação -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    
                    <button class="btn btn-primary" onclick="downloadMapImage()">
                        <i class="fas fa-download"></i> Baixar Imagem
                    </button>
                    <button class="btn btn-warning" onclick="assignItemsToPositions()">
                        <i class="fas fa-tasks"></i> Atribuir Itens
                    </button>
                    <button class="btn btn-info" onclick="showMapQRCode()">
                        <i class="fas fa-qrcode"></i> QR Code do Mapa
                    </button>
                </div>
            </div>
        `;
        
        // Inicializar controles de zoom
        initializeMapControls();
        } else if (mapId === 'almoxarifado_central') {
    mapModalBody.innerHTML = `
        <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">
            <i class="fas fa-warehouse"></i> Almoxarifado Central - Mapa Completo
        </h3>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <p><strong>Dimensões:</strong> 10.4m / 34ft</p>
            <p><strong>Organização:</strong> 5 Seções (A-E) + 15 Ruas (A-H)</p>
            <p><strong>Total de posições:</strong> 70+ posições identificadas</p>
            <p><strong>Data do Mapa:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
        </div>
        
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <img id="mapImage" 
                         src="mapa_almoxarifado_central.png" 
                         alt="Mapa do Almoxarifado Central" 
                         style="max-width: 100%; max-height: 600px; border-radius: 8px; border: 2px solid var(--border-color); cursor: zoom-in;"
                         onclick="zoomMapImage()"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgdmlld0JveD0iMCAwIDgwMCA2MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBmaWxsPSIjRjVGN0ZBIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iMzAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5NUE1QTYiPk1hcGEgbmFvIGNhcnJlZ2FkbzwvdGV4dD4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWxseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5NUE1QTYiPm1hcGFfYW1veGFyaWZhZG9fY2VudHJhbC5wbmc8L3RleHQ+Cjwvc3ZnPg==';">
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                        <i class="fas fa-search-plus"></i> Clique para ampliar
                    </div>
                </div>
                <p style="margin-top: 10px; color: var(--gray-color); font-size: 14px;">
                    Clique na imagem para visualizar em tela cheia
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                <button class="btn btn-sm btn-primary" onclick="zoomInMap()">
                    <i class="fas fa-search-plus"></i> Aumentar Zoom
                </button>
                <button class="btn btn-sm btn-primary" onclick="zoomOutMap()">
                    <i class="fas fa-search-minus"></i> Diminuir Zoom
                </button>
                <button class="btn btn-sm btn-secondary" onclick="resetMapZoom()">
                    <i class="fas fa-sync-alt"></i> Zoom Original
                </button>
                <button class="btn btn-sm btn-warning" onclick="rotateMapImage()">
                    <i class="fas fa-redo"></i> Girar 90°
                </button>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                
                <button class="btn btn-primary" onclick="downloadMapImage()">
                    <i class="fas fa-download"></i> Baixar Imagem
                </button>
                <button class="btn btn-warning" onclick="assignItemsToPositions()">
                    <i class="fas fa-tasks"></i> Atribuir Itens
                </button>
                <button class="btn btn-info" onclick="showMapQRCode()">
                    <i class="fas fa-qrcode"></i> QR Code do Mapa
                </button>
            </div>
        </div>
    `;
    
    // Inicializar controles de zoom
    initializeMapControls();
    } else {
        // Código para outros mapas permanece o mesmo...
        mapModalBody.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-map-marked-alt" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">Mapa em Desenvolvimento</h3>
                <p style="color: var(--gray-color); margin-bottom: 25px;">O mapa para este local ainda não foi configurado.</p>
                <button class="btn btn-primary" onclick="addNewMap('${mapId}')">
                    <i class="fas fa-plus-circle"></i> Criar Mapa para este Local
                </button>
            </div>
        `;
    }
    
    document.getElementById('mapModal').style.display = 'flex';
}

// Variáveis para controle do zoom e rotação
let mapZoomLevel = 1;
let mapRotation = 0;

// Inicializar controles do mapa
function initializeMapControls() {
    mapZoomLevel = 1;
    mapRotation = 0;
    updateMapImage();
}

// Atualizar imagem do mapa com transformações
function updateMapImage() {
    const mapImage = document.getElementById('mapImage');
    if (mapImage) {
        mapImage.style.transform = `scale(${mapZoomLevel}) rotate(${mapRotation}deg)`;
        mapImage.style.transition = 'transform 0.3s ease';
    }
}

// Zoom in
function zoomInMap() {
    if (mapZoomLevel < 3) {
        mapZoomLevel += 0.1;
        updateMapImage();
    }
}

// Zoom out
function zoomOutMap() {
    if (mapZoomLevel > 0.5) {
        mapZoomLevel -= 0.1;
        updateMapImage();
    }
}

// Reset zoom
function resetMapZoom() {
    mapZoomLevel = 1;
    mapRotation = 0;
    updateMapImage();
}

// Rotacionar imagem
function rotateMapImage() {
    mapRotation += 90;
    if (mapRotation >= 360) {
        mapRotation = 0;
    }
    updateMapImage();
}

// Visualizar imagem em tela cheia
function zoomMapImage() {
    const mapImage = document.getElementById('mapImage');
    if (mapImage) {
        viewEnlargedImageObject(mapImage.src, 'Mapa do Container de Ferramentas Elétricas');
    }
}

// Função genérica para visualizar imagem ampliada
function viewEnlargedImageObject(imageSrc, title) {
    // Remover qualquer modal de imagem existente
    const existingModal = document.querySelector('.image-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Criar modal para imagem ampliada
    const modal = document.createElement('div');
    modal.className = 'modal image-modal';
    
    modal.innerHTML = `
        <div style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.95);">
            <div style="position: relative; max-width: 95vw; max-height: 95vh;">
                <button class="image-modal-close" id="closeImageModalBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(128, 128, 128, 0.8); border: 2px solid rgba(255, 255, 255, 0.5); color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
    <i class="fas fa-times"></i>
</button>
                <img src="${imageSrc}" 
                     alt="${title}" 
                     style="max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: 8px; cursor: pointer;">
                <div class="image-caption">
                    <h4>${title}</h4>
                    <p>Container de Ferramentas Elétricas | Dimensões: 2.35m x 7ft</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // Fechar modal ao clicar no botão
    modal.querySelector('#closeImageModalBtn').addEventListener('click', function() {
        modal.remove();
    });
    
    // Fechar modal ao clicar fora da imagem
    modal.addEventListener('click', function(e) {
        if (e.target === modal || e.target.classList.contains('image-modal')) {
            modal.remove();
        }
    });
    
    // Fechar com ESC
    const closeOnEsc = function(e) {
        if (e.key === 'Escape') {
            if (modal.parentNode) {
                modal.remove();
            }
            document.removeEventListener('keydown', closeOnEsc);
        }
    };
    
    document.addEventListener('keydown', closeOnEsc);
}

// Baixar imagem do mapa
function downloadMapImage() {
    const mapImage = document.getElementById('mapImage');
    if (mapImage) {
        const link = document.createElement('a');
        link.download = `mapa_container_eletrico_${new Date().toISOString().slice(0, 10)}.jpg`;
        link.href = mapImage.src;
        link.click();
        showNotification('Imagem do mapa baixada!', 'success');
    } else {
        showNotification('Imagem não encontrada.', 'error');
    }
}

// Mostrar QR Code do mapa
function showMapQRCode() {
    const qrContent = JSON.stringify({
        mapa: 'Container de Ferramentas Elétricas',
        dimensoes: '2.35m x 7ft',
        prateleiras_l: 4,
        prateleiras_r: 10,
        posicoes: 70,
        data_atualizacao: new Date().toISOString().split('T')[0],
        url_imagem: document.getElementById('mapImage')?.src || ''
    }, null, 2);
    
    const qrModalBody = document.getElementById('qrModalBody');
    qrModalBody.innerHTML = `
        <div class="qrcode-container">
            <h4 style="margin-bottom: 20px;">QR Code do Mapa</h4>
            <p style="margin-bottom: 15px;">Container de Ferramentas Elétricas</p>
            <div id="qrcodeCanvas" style="margin: 0 auto 20px;"></div>
            <p style="margin-top: 20px; color: var(--gray-color); font-size: 14px;">
                Use este QR Code para acessar o mapa digitalmente.
            </p>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" id="downloadQRCodeBtn">
                    <i class="fas fa-download"></i> Baixar QR Code
                </button>
                <button class="btn btn-success" id="printQRCodeBtn">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    `;
    
    // Gerar QR Code
    QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrContent, {
        width: 200,
        margin: 2,
        color: { dark: '#000000', light: '#FFFFFF' }
    });
    
    // Configurar botões
    document.getElementById('downloadQRCodeBtn').onclick = function() {
        const canvas = document.querySelector('#qrcodeCanvas canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `QRCode_Mapa_Container_Eletrico.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    };
    
    document.getElementById('printQRCodeBtn').onclick = function() {
        window.print();
    };
    
    document.getElementById('qrModal').style.display = 'flex';
}

        // Gerar HTML para as prateleiras
        function generateShelvesHTML(side, count) {
            let html = '';
            const colors = side === 'L' 
                ? ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6']
                : ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8'];
            
            for (let i = 1; i <= count; i++) {
                const colorIndex = (i - 1) % colors.length;
                html += `
                    <div style="background-color: ${colors[colorIndex]}; border: 1px solid ${colors[colorIndex].replace(')', ', 0.8)').replace('rgb', 'rgba')}; border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: var(--primary-color);">
                            ${side}${i}
                        </div>
                        <div style="display: flex; justify-content: center; gap: 5px; font-size: 12px;">
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">a</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">b</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">c</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">d</span>
                            <span style="background-color: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd;">e</span>
                        </div>
                        <div style="font-size: 11px; color: var(--gray-color); margin-top: 5px;">
                            ${getRandomItemCount()} itens
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // Função auxiliar para número aleatório de itens
        function getRandomItemCount() {
            const counts = [0, 1, 2, 3, 4, 5];
            return counts[Math.floor(Math.random() * counts.length)];
        }

        // Adicionar novo mapa
        function addNewMap(mapId = '') {
            showNotification('Funcionalidade em desenvolvimento.', 'info');
        }


        // Exportar mapa para PDF
        function exportMapToPDF() {
            showNotification('Exportação para PDF em desenvolvimento.', 'info');
        }

        // Atribuir itens a posições
        function assignItemsToPositions() {
            showNotification('Funcionalidade de atribuição em desenvolvimento.', 'info');
        }

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO
        // ============================================

        // Função de login
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // Verificar credenciais
            let user = null;
            let userKey = null;
            
            // Verificar por email
            if (users[email]) {
                user = users[email];
                userKey = email;
            }
            
            // Se não encontrou por email, tentar por nome de usuário
            if (!user && email === 'fwuser') {
                user = users['fwuser'];
                userKey = 'fwuser';
            }
            
            if (user && user.password === password) {
                // Login bem-sucedido
                currentUser = {
                    ...user,
                    key: userKey
                };
                
                // Salvar sessão
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // SEMPRE usar as credenciais fixas do Supabase
                dbConfig = FIXED_SUPABASE_CONFIG;
                localStorage.setItem('supabaseConfig', JSON.stringify(dbConfig));
                
                // Mostrar dashboard
                showDashboard();
                
                // Configurar interface baseada no perfil
                setupUserInterface();
                
                // Inicializar sistema - PARA TODOS OS USUÁRIOS
                initializeSystem();
                
            } else {
                // Login falhou
                errorDiv.classList.add('show');
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLogin();
            }
        }

        // Verificar sessão ativa
        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Verificar se o usuário ainda existe
                    if (users[currentUser.key] && users[currentUser.key].password === currentUser.password) {
                        // Configurar dbConfig com credenciais fixas
                        dbConfig = FIXED_SUPABASE_CONFIG;
                        
                        showDashboard();
                        setupUserInterface();
                        initializeSystem();
                        return;
                    }
                } catch (e) {
                    console.error('Erro ao restaurar sessão:', e);
                }
            }
            
            // Se não houver sessão válida, mostrar login
            showLogin();
        }

        // Mostrar tela de login
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('fixedCloudUploadBtn').style.display = 'none';
            
            // Limpar campos
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // Atualizar informações do usuário
            if (currentUser) {
                document.getElementById('userWelcomeText').textContent = `Bem-vindo, ${currentUser.name}`;
                document.getElementById('userRoleBadge').textContent = getRoleDisplayName(currentUser.role);
                document.getElementById('userRoleBadge').className = `user-badge ${getRoleBadgeClass(currentUser.role)}`;
            }
        }

        // Configurar interface baseada no perfil
        function setupUserInterface() {
            if (!currentUser) return;
            
            const role = currentUser.role;
            
            // Esconder elementos baseado no perfil
            const cadastroTab = document.getElementById('cadastroTab');
            const databaseTab = document.getElementById('databaseTab');
            const backupCard = document.getElementById('backupCard');
            const storageInfo = document.getElementById('storageInfo');
            const imageCaptureContainer = document.getElementById('imageCaptureContainer');
            
            switch(role) {
                case 'dev':
                    // Acesso total - mostrar tudo
                    cadastroTab.classList.remove('hidden');
                    databaseTab.classList.remove('hidden');
                    if (backupCard) backupCard.classList.remove('hidden');
                    if (storageInfo) storageInfo.classList.remove('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.remove('hidden');
                    break;
                    
                case 'almoxarife':
                    // Acesso: Dashboard, Cadastro, Catálogo, Exportar
                    cadastroTab.classList.remove('hidden');
                    databaseTab.classList.add('hidden');
                    if (backupCard) backupCard.classList.add('hidden');
                    if (storageInfo) storageInfo.classList.remove('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.remove('hidden');
                    break;
                    
                case 'user':
                    // Acesso: Dashboard, Catálogo, Exportar (apenas consulta)
                    cadastroTab.classList.add('hidden');
                    databaseTab.classList.add('hidden');
                    if (backupCard) backupCard.classList.add('hidden');
                    if (storageInfo) storageInfo.classList.add('hidden');
                    if (imageCaptureContainer) imageCaptureContainer.classList.add('hidden');
                    
                    // Desabilitar ações nos formulários
                    const formElements = document.querySelectorAll('#toolForm input, #toolForm select, #toolForm textarea');
                    formElements.forEach(el => el.disabled = true);
                    
                    // Esconder botões de ação no catálogo
                    const actionButtons = document.querySelectorAll('.action-btn-edit, .action-btn-delete');
                    actionButtons.forEach(btn => btn.style.display = 'none');
                    break;
            }
        }

        // Funções auxiliares para perfis
        function getRoleDisplayName(role) {
            switch(role) {
                case 'dev': return 'DEV';
                case 'almoxarife': return 'Almoxarife';
                case 'user': return 'Usuário';
                default: return 'Usuário';
            }
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'dev': return 'status-completed';
                case 'almoxarife': return 'status-ontrack';
                case 'user': return 'status-delayed';
                default: return '';
            }
        }

        // ============================================
        // FUNÇÕES PRINCIPAIS DO SISTEMA
        // ============================================

        // Inicializar sistema com conexão automática
        async function initializeSystem() {
            try {
                console.log('🔧 INICIALIZANDO SISTEMA para:', currentUser?.email);
                
                // 1. Adicionar campo oculto para usuário
                const usuarioField = document.createElement('input');
                usuarioField.type = 'hidden';
                usuarioField.id = 'usuarioCadastroField';
                usuarioField.value = currentUser ? currentUser.name : 'Sistema';
                document.getElementById('toolForm').appendChild(usuarioField);
                
                // 2. Carregar dados locais
                await loadInitialTools();
                console.log('📁 Dados locais carregados:', tools.length, 'itens');
                
                // 3. Carregar colaboradores
                loadColaboradores();
                console.log('👥 Colaboradores carregados:', colaboradores.length);
                
                // 4. Verificar status do IndexedDB
                await updateIndexedDBStatus();
                
                // 5. ATUALIZAR INTERFACE INICIAL
                updateHeaderStats();
                updateStatistics();
                loadToolsList();
                updateColaboradoresList();
                
                // 6. Configurar data atual
                document.getElementById('dataCadastro').value = new Date().toISOString().split('T')[0];
                document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
                
                // 7. SEMPRE tentar conectar ao Supabase com credenciais fixas
                console.log('☁️ Conectando automaticamente ao Supabase...');
                console.log('URL:', FIXED_SUPABASE_CONFIG.url);
                
                const connected = await setupSupabaseClient();
                
                if (connected) {
                    console.log('✅ Conectado ao Supabase! Buscando dados...');
                    
                    // 8. Para TODOS os usuários, buscar dados da nuvem
                    setTimeout(async () => {
                        try {
                            const fetched = await fetchFromSupabase();
                            if (fetched) {
                                console.log('✅ Dados sincronizados da nuvem');
                                lastSyncTime = new Date();
                                updateConnectionStatus();
                            }
                        } catch (syncError) {
                            console.error('❌ Erro na sincronização automática:', syncError);
                        }
                    }, 1000);
                    
                } else {
                    console.log('⚠️ Modo local ativo');
                    showNotification('Modo local ativo.', 'info');
                }
                
                // 9. Mostrar botão de enviar para nuvem (se tiver permissão)
                showCloudUploadButton();
                
                // 10. Atualizar status da conexão
                updateConnectionStatus();
                
                showNotification('Sistema inicializado!', 'success');
                console.log('✅ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showNotification('Erro ao inicializar.', 'error');
            }
        }

        // Mostrar botão de enviar para nuvem
        function showCloudUploadButton() {
            const cloudUploadBtn = document.getElementById('fixedCloudUploadBtn');
            
            // Mostrar apenas se usuário tiver permissão
            if (currentUser.role !== 'user') {
                cloudUploadBtn.style.display = 'flex';
            } else {
                cloudUploadBtn.style.display = 'none';
            }
        }

        // Verificar status do IndexedDB
        function checkIndexedDBStatus() {
            return new Promise((resolve) => {
                if (!window.indexedDB) {
                    resolve({ available: false, status: 'Não suportado' });
                    return;
                }

                const request = indexedDB.open('testConnection', 1);
                let dbConnected = false;

                request.onsuccess = () => {
                    dbConnected = true;
                    request.result.close();
                    resolve({ available: true, status: 'Conectado' });
                };

                request.onerror = () => {
                    resolve({ available: false, status: 'Erro' });
                };

                request.onblocked = () => {
                    resolve({ available: false, status: 'Bloqueado' });
                };

                // Timeout para detectar se está muito lento
                setTimeout(() => {
                    if (!dbConnected) {
                        resolve({ available: false, status: 'Timeout' });
                    }
                }, 1000);
            });
        }

        // Função para atualizar o status do IndexedDB na interface
        async function updateIndexedDBStatus() {
            try {
                const status = await checkIndexedDBStatus();
                const statusElement = document.getElementById('indexedDBStatus');
                
                if (status.available && status.status === 'Conectado') {
                    statusElement.textContent = 'Conectado';
                    statusElement.className = 'status-badge status-completed';
                } else {
                    statusElement.textContent = 'Desconectado';
                    statusElement.className = 'status-badge status-delayed';
                }
                
                return status.available;
            } catch (error) {
                console.error('Erro ao verificar IndexedDB:', error);
                const statusElement = document.getElementById('indexedDBStatus');
                statusElement.textContent = 'Erro';
                statusElement.className = 'status-badge status-delayed';
                return false;
            }
        }

        // ============================================
        // DADOS DE EXEMPLO
        // ============================================

        function getExampleTools() {
            return [
                {
                    id: 1,
                    name: 'Martelo de Borracha',
                    code: 'MART-001',
                    patrimonio: 'PAT-2023-001',
                    ncm: '8205.70.00',
                    category: 'Ferramentas Manuais',
                    status: 'Disponível',
                    location: 'Almoxarifado Central',
                    condition: 'Bom',
                    notaFiscal: 'NF-2023-001234',
                    unidade: 'UN',
                    preco: 45.90,
                    quantidade: 5,
                    estoqueMinimo: 2,
                    estoqueMaximo: 10,
                    dataCadastro: '2023-10-15',
                    description: 'Martelo de borracha para montagens delicadas',
                    observations: 'Novo em folha',
                    image: null,
                    usuarioCadastro: 'Sistema',
                    dataHoraCadastro: '2023-10-15T10:30:00Z',
                    createdAt: '2023-10-15T10:30:00Z',
                    updatedAt: '2023-10-15T10:30:00Z'
                },
                {
                    id: 2,
                    name: 'Parafusadeira Elétrica',
                    code: 'PARAF-001',
                    patrimonio: 'PAT-2023-002',
                    ncm: '8467.21.00',
                    category: 'Ferramentas Elétricas',
                    status: 'Em Uso',
                    location: 'Oficina',
                    condition: 'Novo',
                    notaFiscal: 'NF-2023-001235',
                    unidade: 'UN',
                    preco: 289.90,
                    quantidade: 3,
                    estoqueMinimo: 1,
                    estoqueMaximo: 5,
                    dataCadastro: '2023-10-16',
                    description: 'Parafusadeira elétrica 18V com bateria',
                    observations: 'Em uso pelo técnico João',
                    image: null,
                    usuarioCadastro: 'Emerson Silva',
                    dataHoraCadastro: '2023-10-16T14:20:00Z',
                    createdAt: '2023-10-16T14:20:00Z',
                    updatedAt: '2023-10-16T14:20:00Z'
                },
                {
                    id: 3,
                    name: 'Capacete de Segurança',
                    code: 'EPI-001',
                    patrimonio: 'PAT-2023-003',
                    ncm: '6506.10.00',
                    category: 'EPI',
                    status: 'Disponível',
                    location: 'Container Mecânica',
                    condition: 'Bom',
                    notaFiscal: 'NF-2023-001236',
                    unidade: 'UN',
                    preco: 89.50,
                    quantidade: 12,
                    estoqueMinimo: 5,
                    estoqueMaximo: 20,
                    dataCadastro: '2023-10-17',
                    description: 'Capacete de segurança industrial',
                    observations: 'Com jugular ajustável',
                    image: null,
                    usuarioCadastro: 'Fábio Mendes',
                    dataHoraCadastro: '2023-10-17T09:15:00Z',
                    createdAt: '2023-10-17T09:15:00Z',
                    updatedAt: '2023-10-17T09:15:00Z'
                }
            ];
        }

        // Carregar dados iniciais
        async function loadInitialTools() {
            try {
                const localData = localStorage.getItem('tools');
                if (localData) {
                    tools = JSON.parse(localData) || [];
                } else {
                    tools = getExampleTools();
                    await saveTools();
                }
                
                updateStorageInfo();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                tools = getExampleTools();
            }
        }

        // Salvar dados localmente
        async function saveTools() {
            try {
                localStorage.setItem('tools', JSON.stringify(tools));
                updateStorageInfo();
                updateConnectionStatus();
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showNotification('Erro ao salvar dados localmente.', 'error');
                return false;
            }
        }

        // Configurar cliente Supabase
        async function setupSupabaseClient() {
            try {
                console.log('🛠️ Configurando cliente Supabase...');
                console.log('URL:', FIXED_SUPABASE_CONFIG.url);
                console.log('KEY:', FIXED_SUPABASE_CONFIG.key ? 'Presente' : 'Ausente');
                
                // Verificar credenciais
                if (!FIXED_SUPABASE_CONFIG.url || !FIXED_SUPABASE_CONFIG.key) {
                    console.error('❌ Credenciais ausentes');
                    return false;
                }
                
                // Criar cliente
                supabaseClient = supabase.createClient(FIXED_SUPABASE_CONFIG.url, FIXED_SUPABASE_CONFIG.key);
                isOnlineMode = true;
                
                console.log('🔌 Testando conexão...');
                const connectionResult = await testSupabaseConnection();
                console.log('Resultado do teste:', connectionResult);
                
                if (connectionResult.success) {
                    document.getElementById('storageStatus').textContent = 'Online';
                    document.getElementById('storageStatus').className = 'status-badge status-completed';
                    
                    console.log('✅ Conectado ao Supabase com sucesso!');
                    showNotification('Conectado à nuvem!', 'success');
                    
                    // Atualizar info do banco
                    updateDatabaseInfo();
                    updateConnectionStatus();
                    
                    return true;
                } else {
                    isOnlineMode = false;
                    console.error('❌ Falha na conexão:', connectionResult.message);
                    showNotification(`Falha: ${connectionResult.message}`, 'error');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ Erro ao configurar Supabase:', error);
                isOnlineMode = false;
                showNotification('Erro de conexão com a nuvem.', 'error');
                return false;
            }
        }

        // Testar conexão com Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        return { success: false, message: 'Tabela não existe.' };
                    }
                    throw error;
                }
                
                return { success: true, message: 'Conexão estabelecida!' };
            } catch (error) {
                return { success: false, message: `Erro: ${error.message}` };
            }
        }

        // ============================================
        // FUNÇÃO CORRIGIDA: BUSCAR DADOS DO SUPABASE
        // ============================================

        // Buscar dados do Supabase (CORRIGIDA)
        async function fetchFromSupabase() {
            try {
                // Verificar se está conectado
                if (!isOnlineMode || !supabaseClient) {
                    showNotification('Não conectado à nuvem.', 'warning');
                    return false;
                }
                
                const limit = parseInt(document.getElementById('syncLimit')?.value) || 100;
                
                console.log(`🔄 Buscando até ${limit} itens do Supabase...`);
                
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(limit);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        showNotification('Tabela não existe no banco de dados.', 'error');
                        return false;
                    }
                    throw error;
                }
                
                if (data && data.length > 0) {
                    console.log(`📥 ${data.length} itens recebidos do Supabase`);
                    
                    // Converter para formato local
                    const convertedTools = data.map(item => ({
                        id: item.id || Date.now(),
                        name: item.name,
                        code: item.code,
                        patrimonio: item.patrimonio,
                        ncm: item.ncm,
                        category: item.category,
                        status: item.status,
                        location: item.location,
                        condition: item.condition,
                        notaFiscal: item.nota_fiscal,
                        unidade: item.unidade,
                        preco: item.preco,
                        quantidade: item.quantidade,
                        estoqueMinimo: item.estoque_minimo,
                        estoqueMaximo: item.estoque_maximo,
                        description: item.description,
                        observations: item.observations,
                        image: item.image_url,
                        usuarioCadastro: item.usuario_cadastro || 'Sistema',
                        dataCadastro: item.data_cadastro,
                        createdAt: item.created_at,
                        updatedAt: item.updated_at
                    }));
                    
                    // CORREÇÃO PRINCIPAL: Mesclar dados corretamente
                    // 1. Criar mapa dos dados da nuvem pelo código
                    const cloudMap = new Map();
                    convertedTools.forEach(tool => {
                        cloudMap.set(tool.code, tool);
                    });
                    
                    // 2. Atualizar itens existentes e adicionar novos
                    let updatedCount = 0;
                    let addedCount = 0;
                    
                    tools.forEach((localTool, index) => {
                        const cloudTool = cloudMap.get(localTool.code);
                        if (cloudTool) {
                            // Se já existe localmente, atualiza com dados da nuvem
                            tools[index] = {
                                ...localTool,
                                ...cloudTool,
                                id: localTool.id, // Mantém o ID local
                                updatedAt: new Date().toISOString()
                            };
                            updatedCount++;
                            cloudMap.delete(localTool.code); // Remove do mapa para não adicionar novamente
                        }
                    });
                    
                    // 3. Adicionar itens que não existiam localmente
                    const newTools = Array.from(cloudMap.values());
                    if (newTools.length > 0) {
                        tools = [...tools, ...newTools];
                        addedCount = newTools.length;
                    }
                    
                    // 4. Salvar e atualizar interface
                    await saveTools();
                    updateInterface();
                    lastSyncTime = new Date();
                    updateConnectionStatus();
                    
                    if (updatedCount > 0 || addedCount > 0) {
                        showNotification(`${updatedCount} itens atualizados, ${addedCount} novos adicionados da nuvem!`, 'success');
                        console.log(`✅ ${updatedCount} atualizados, ${addedCount} novos`);
                    } else {
                        showNotification('Dados já sincronizados.', 'info');
                    }
                    
                    return true;
                } else {
                    showNotification('Nenhum dado encontrado na nuvem.', 'info');
                    return false;
                }
            } catch (error) {
                console.error('Erro ao buscar do Supabase:', error);
                showNotification(`Erro ao buscar dados: ${error.message}`, 'error');
                return false;
            }
        }

        // ============================================
        // FUNÇÕES DE INTERFACE
        // ============================================

        // Atualizar cabeçalho
        function updateHeaderStats() {
            document.getElementById('totalTools').textContent = tools.length;
            
            // Calcular valor total
            const totalValue = tools.reduce((sum, tool) => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                return sum + (preco * quantidade);
            }, 0);
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('pt-BR');
        }

        // Atualizar informações de armazenamento
        function updateStorageInfo() {
            const storageInfoText = document.getElementById('storageInfoText');
            if (storageInfoText) {
                const dataSize = JSON.stringify(tools).length;
                const sizeKB = Math.round(dataSize / 1024);
                storageInfoText.textContent = `Itens: ${tools.length} | Tamanho: ${sizeKB} KB`;
            }
        }

        // Atualizar estatísticas
        function updateStatistics() {
            const total = tools.length;
            
            if (total === 0) {
                resetStats();
                return;
            }
            
            const availableCount = tools.filter(tool => tool.status === 'Disponível').length;
            const inUseCount = tools.filter(tool => tool.status === 'Em Uso').length;
            const maintenanceCount = tools.filter(tool => tool.status === 'Manutenção').length;
            const damagedCount = tools.filter(tool => tool.status === 'Danificado').length;
            
            updateProgressBars(total, availableCount, inUseCount, maintenanceCount, damagedCount);
            updateValueStats();
            updateLowStockItems();
            updateLocationChart();
        }

        function resetStats() {
            document.getElementById('availablePercent').textContent = '0%';
            document.getElementById('inUsePercent').textContent = '0%';
            document.getElementById('maintenancePercent').textContent = '0%';
            document.getElementById('damagedPercent').textContent = '0%';
            
            document.getElementById('availableBar').style.width = '0%';
            document.getElementById('inUseBar').style.width = '0%';
            document.getElementById('maintenanceBar').style.width = '0%';
            document.getElementById('damagedBar').style.width = '0%';
            
            document.getElementById('valueStats').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item cadastrado</p>';
            document.getElementById('lowStockItems').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item cadastrado</p>';
            
            if (chartInstance) {
                chartInstance.destroy();
            }
        }

        function updateProgressBars(total, available, inUse, maintenance, damaged) {
            const availablePercent = Math.round((available / total) * 100);
            const inUsePercent = Math.round((inUse / total) * 100);
            const maintenancePercent = Math.round((maintenance / total) * 100);
            const damagedPercent = Math.round((damaged / total) * 100);
            
            document.getElementById('availablePercent').textContent = `${availablePercent}%`;
            document.getElementById('inUsePercent').textContent = `${inUsePercent}%`;
            document.getElementById('maintenancePercent').textContent = `${maintenancePercent}%`;
            document.getElementById('damagedPercent').textContent = `${damagedPercent}%`;
            
            document.getElementById('availableBar').style.width = `${availablePercent}%`;
            document.getElementById('inUseBar').style.width = `${inUsePercent}%`;
            document.getElementById('maintenanceBar').style.width = `${maintenancePercent}%`;
            document.getElementById('damagedBar').style.width = `${damagedPercent}%`;
        }

        function updateValueStats() {
            const categoryValue = {};
            tools.forEach(tool => {
                const preco = parseFloat(tool.preco) || 0;
                const quantidade = parseInt(tool.quantidade) || 1;
                const valor = preco * quantidade;
                
                if (!categoryValue[tool.category]) {
                    categoryValue[tool.category] = 0;
                }
                categoryValue[tool.category] += valor;
            });
            
            const totalValue = Object.values(categoryValue).reduce((a, b) => a + b, 0);
            let valueHTML = '';
            
            for (const [category, value] of Object.entries(categoryValue)) {
                const percent = totalValue > 0 ? Math.round((value / totalValue) * 100) : 0;
                valueHTML += `
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>${category}</span>
                            <span>${formatCurrency(value)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%; background-color: ${getRandomColor()}"></div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('valueStats').innerHTML = valueHTML || '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum valor cadastrado</p>';
        }

        function updateLowStockItems() {
            const lowStockItems = tools.filter(tool => {
                const quantidade = parseInt(tool.quantidade) || 0;
                const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
            }).slice(0, 5);
            
            if (lowStockItems.length > 0) {
                let lowStockHTML = '';
                lowStockItems.forEach(item => {
                    lowStockHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <div>
                                <p style="font-weight: 500; margin-bottom: 2px;">${item.name}</p>
                                <p style="font-size: 12px; color: var(--gray-color);">${item.code} | Estoque: ${item.quantidade} | Mínimo: ${item.estoqueMinimo}</p>
                            </div>
                            <span class="status-badge status-delayed">Baixo</span>
                        </div>
                    `;
                });
                document.getElementById('lowStockItems').innerHTML = lowStockHTML;
            } else {
                document.getElementById('lowStockItems').innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px 0;">Nenhum item com estoque baixo</p>';
            }
        }

        function updateLocationChart() {
            const ctx = document.getElementById('locationChart').getContext('2d');
            
            const locations = {};
            tools.forEach(tool => {
                locations[tool.location] = (locations[tool.location] || 0) + 1;
            });
            
            const locationLabels = Object.keys(locations);
            const locationData = Object.values(locations);
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            if (locationLabels.length > 0) {
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: locationLabels,
                        datasets: [{
                            label: 'Itens',
                            data: locationData,
                            backgroundColor: locationLabels.map(() => getRandomColor()),
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} itens`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
        }

        // ============================================
        // FUNÇÕES AUXILIARES
        // ============================================

        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                return new Date(dateString).toLocaleDateString('pt-BR');
            } catch (e) {
                return dateString;
            }
        }

        // Formatar moeda
        function formatCurrency(value) {
            if (!value && value !== 0) return 'R$ 0,00';
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
        }

        // Formatar moeda para exportação
        function formatCurrencyForExport(value) {
            if (!value && value !== 0) return '0,00';
            return parseFloat(value).toFixed(2).replace('.', ',');
        }

        // Gerar cor aleatória
        function getRandomColor() {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Mostrar notificação
        function showNotification(message, type) {
            const existing = document.querySelectorAll('.notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Limpar formulário
        function clearForm() {
            document.getElementById('toolForm').reset();
            document.getElementById('dataCadastro').value = new Date().toISOString().split('T')[0];
            document.getElementById('cameraPlaceholder').style.display = 'block';
            document.getElementById('toolImagePreview').style.display = 'none';
            document.getElementById('toolImagePreview').src = '';
            currentToolImage = null;
            
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            isEditing = false;
            editingToolId = null;
            
            const saveBtn = document.getElementById('saveToolBtn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Item';
        }

        // Atualizar interface completa
        function updateInterface() {
            updateHeaderStats();
            updateStatistics();
            loadToolsList(currentStatusFilter);
            updateStorageInfo();
            updateConnectionStatus();
            updateColaboradoresList();
        }

        // ============================================
        // FUNÇÕES DE FORMULÁRIO
        // ============================================

        // Validar formulário
        function validateForm() {
            let isValid = true;
            
            const toolName = document.getElementById('toolName').value.trim();
            const toolCode = document.getElementById('toolCode').value.trim();
            const ncmCode = document.getElementById('ncmCode').value.trim();
            const toolCategory = document.getElementById('toolCategory').value;
            const toolStatus = document.getElementById('toolStatus').value;
            const toolLocation = document.getElementById('toolLocation').value;
            const toolCondition = document.getElementById('toolCondition').value;
            
            // Limpar erros
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Validar campos obrigatórios
            if (!toolName) {
                document.getElementById('toolName').classList.add('error');
                document.getElementById('toolNameError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolCode) {
                document.getElementById('toolCode').classList.add('error');
                document.getElementById('toolCodeError').textContent = 'O código é obrigatório';
                document.getElementById('toolCodeError').style.display = 'block';
                isValid = false;
            } else if (isEditing) {
                if (tools.some(tool => tool.code === toolCode && tool.id !== editingToolId)) {
                    document.getElementById('toolCode').classList.add('error');
                    document.getElementById('toolCodeError').textContent = 'Já existe um item com este código';
                    document.getElementById('toolCodeError').style.display = 'block';
                    isValid = false;
                }
            } else {
                if (tools.some(tool => tool.code === toolCode)) {
                    document.getElementById('toolCode').classList.add('error');
                    document.getElementById('toolCodeError').textContent = 'Já existe um item com este código';
                    document.getElementById('toolCodeError').style.display = 'block';
                    isValid = false;
                }
            }
            
            if (!toolCategory) {
                document.getElementById('toolCategory').classList.add('error');
                document.getElementById('toolCategoryError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolStatus) {
                document.getElementById('toolStatus').classList.add('error');
                document.getElementById('toolStatusError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolLocation) {
                document.getElementById('toolLocation').classList.add('error');
                document.getElementById('toolLocationError').style.display = 'block';
                isValid = false;
            }
            
            if (!toolCondition) {
                document.getElementById('toolCondition').classList.add('error');
                document.getElementById('toolConditionError').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Salvar item
        async function saveTool() {
            if (!validateForm()) {
                showNotification('Preencha todos os campos obrigatórios!', 'error');
                return false;
            }
            
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para salvar itens.', 'error');
                return false;
            }
            
            try {
                const toolData = getFormData();
                
                if (isEditing && editingToolId) {
                    await updateTool(editingToolId, toolData);
                } else {
                    await createTool(toolData);
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showNotification('Erro ao salvar item.', 'error');
                return false;
            }
        }

        function getFormData() {
            const usuario = currentUser ? currentUser.name : 'Sistema';
            
            return {
                name: document.getElementById('toolName').value.trim(),
                code: document.getElementById('toolCode').value.trim(),
                patrimonio: document.getElementById('patrimonioNumber').value.trim(),
                ncm: document.getElementById('ncmCode').value.trim(),
                category: document.getElementById('toolCategory').value,
                status: document.getElementById('toolStatus').value,
                location: document.getElementById('toolLocation').value,
                condition: document.getElementById('toolCondition').value,
                notaFiscal: document.getElementById('notaFiscal').value.trim(),
                unidade: document.getElementById('unidadeMedida').value,
                preco: parseFloat(document.getElementById('preco').value) || 0,
                quantidade: parseInt(document.getElementById('quantidadeAtual').value) || 1,
                estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value) || 0,
                estoqueMaximo: parseInt(document.getElementById('estoqueMaximo').value) || 0,
                dataCadastro: document.getElementById('dataCadastro').value,
                description: document.getElementById('toolDescription').value.trim(),
                observations: document.getElementById('toolObservations').value.trim(),
                image: currentToolImage,
                usuarioCadastro: usuario,
                dataHoraCadastro: new Date().toISOString()
            };
        }

        async function createTool(toolData) {
            const newTool = {
                id: Date.now(),
                ...toolData,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            tools.push(newTool);
            
            await saveTools();
            
            // Salvar no Supabase se estiver conectado
            if (isOnlineMode && supabaseClient) {
                await saveToolToSupabase(newTool);
            }
            
            updateInterface();
            showNotification('Item cadastrado com sucesso!', 'success');
            clearForm();
        }

        async function updateTool(toolId, toolData) {
            const toolIndex = tools.findIndex(t => t.id === toolId);
            
            if (toolIndex === -1) {
                showNotification('Item não encontrado!', 'error');
                return false;
            }
            
            const updatedTool = {
                ...tools[toolIndex],
                ...toolData,
                updatedAt: new Date().toISOString()
            };
            
            tools[toolIndex] = updatedTool;
            
            await saveTools();
            
            // Atualizar no Supabase se estiver conectado
            if (isOnlineMode && supabaseClient) {
                await saveToolToSupabase(updatedTool);
            }
            
            updateInterface();
            showNotification('Item atualizado com sucesso!', 'success');
            clearForm();
            
            return true;
        }

        // Converter para formato Supabase
        function convertToSupabaseFormat(tool) {
            return {
                name: tool.name,
                code: tool.code,
                patrimonio: tool.patrimonio || null,
                ncm: tool.ncm,
                category: tool.category,
                status: tool.status,
                location: tool.location,
                condition: tool.condition,
                nota_fiscal: tool.notaFiscal || null,
                unidade: tool.unidade || 'UN',
                preco: tool.preco || 0,
                quantidade: tool.quantidade || 1,
                estoque_minimo: tool.estoqueMinimo || 0,
                estoque_maximo: tool.estoqueMaximo || 0,
                description: tool.description || null,
                observations: tool.observations || null,
                image_url: tool.image || null,
                usuario_cadastro: tool.usuarioCadastro || (currentUser ? currentUser.name : 'Sistema'),
                data_cadastro: tool.dataCadastro || new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString()
            };
        }

        // Salvar no Supabase
        async function saveToolToSupabase(tool) {
            try {
                const toolData = convertToSupabaseFormat(tool);
                
                // Verificar se já existe
                const { data: existing } = await supabaseClient
                    .from('tools')
                    .select('id')
                    .eq('code', tool.code)
                    .maybeSingle();
                
                if (existing) {
                    // Atualizar
                    const { error } = await supabaseClient
                        .from('tools')
                        .update(toolData)
                        .eq('code', tool.code);
                    
                    if (error) throw error;
                } else {
                    // Inserir
                    toolData.created_at = tool.createdAt || new Date().toISOString();
                    
                    const { error } = await supabaseClient
                        .from('tools')
                        .insert([toolData]);
                    
                    if (error) throw error;
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar no Supabase:', error);
                showNotification('Erro ao salvar na nuvem.', 'warning');
                return false;
            }
        }

        // ============================================
        // FUNÇÕES DE LISTAGEM ATUALIZADAS
        // ============================================

        // Carregar lista de itens com filtro por status
        function loadToolsList(statusFilter = 'all') {
            currentStatusFilter = statusFilter;
            const tbody = document.getElementById('toolsTableBody');
            const noToolsRow = document.getElementById('noToolsRow');
            
            tbody.innerHTML = '';
            tbody.appendChild(noToolsRow);
            
            let filteredTools = tools;
            
            // Aplicar filtro de status (CORRIGIDO)
if (statusFilter !== 'all') {
    filteredTools = tools.filter(tool => {
        // Verificar se a ferramenta está atribuída
        const estaAtribuida = isToolAssigned(tool.id);
        
        if (statusFilter === 'Em Uso') {
            // Para filtro "Em Uso", mostrar tanto ferramentas com status "Em Uso"
            // QUANTO ferramentas atribuídas (mesmo se status for "Disponível")
            return tool.status === 'Em Uso' || estaAtribuida;
        } else {
            // Para outros filtros, usar apenas o status
            return tool.status === statusFilter;
        }
    });
}
            
            // Aplicar filtro de estoque baixo
            const lowStockBtn = document.getElementById('filterLowStockBtn');
            const isLowStockFilter = lowStockBtn.classList.contains('active');
            
            if (isLowStockFilter) {
                filteredTools = filteredTools.filter(tool => {
                    const quantidade = parseInt(tool.quantidade) || 0;
                    const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                    return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
                });
            }
            
            const searchTerm = document.getElementById('searchTool')?.value.toLowerCase();
            if (searchTerm) {
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) ||
                    tool.code.toLowerCase().includes(searchTerm) ||
                    (tool.patrimonio && tool.patrimonio.toLowerCase().includes(searchTerm)) ||
                    tool.category.toLowerCase().includes(searchTerm) ||
                    (tool.usuarioCadastro && tool.usuarioCadastro.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredTools.length === 0) {
                noToolsRow.style.display = 'table-row';
                noToolsRow.innerHTML = `<td colspan="14" style="text-align: center; padding: 40px; color: var(--gray-color);">
                    Nenhum item encontrado${searchTerm ? ' para "' + searchTerm + '"' : ''}
                </td>`;
                return;
            }
            
            noToolsRow.style.display = 'none';
            
            filteredTools.forEach(tool => {
                const row = document.createElement('tr');
                row.innerHTML = createTableRow(tool);
                tbody.appendChild(row);
            });
            
            addRowEventListeners();
        }

        function createTableRow(tool) {
    // VERIFICAR SE A FERRAMENTA ESTÁ ATRIBUÍDA
    const estaAtribuida = isToolAssigned(tool.id);
    
    // Se estiver atribuída, mostrar "Em Uso" mesmo se estiver marcada como "Disponível"
    const statusParaExibir = estaAtribuida ? 'Em Uso' : tool.status;
    const statusClass = getStatusClass(statusParaExibir);
    const stockInfo = getStockInfo(tool);
    
    // Verificar permissões para ações
    const canEdit = currentUser.role !== 'user';
    
    // Gerar HTML para a miniatura da imagem
    let imageHTML = '';
    if (tool.image) {
        imageHTML = `
            <div class="tool-thumbnail-container" style="position: relative; display: inline-block;">
                <img src="${tool.image}" 
                     alt="${tool.name}" 
                     class="tool-thumbnail" 
                     data-id="${tool.id}"
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd; cursor: zoom-in;"
                     title="Clique para ampliar">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                           background: rgba(0,0,0,0.2); border-radius: 6px; opacity: 0; 
                           transition: opacity 0.3s; pointer-events: none;">
                    <i class="fas fa-search-plus" style="position: absolute; top: 50%; left: 50%; 
                       transform: translate(-50%, -50%); color: white; font-size: 14px;"></i>
                </div>
            </div>
        `;
    } else {
        imageHTML = `
            <div class="no-image-placeholder" data-id="${tool.id}" 
                 style="width: 50px; height: 50px; background: #f5f5f5; border-radius: 6px; 
                        display: flex; align-items: center; justify-content: center; 
                        border: 2px solid #ddd; cursor: pointer;" 
                 title="Sem imagem - Clique para ver detalhes">
                <i class="fas fa-image" style="color: #ccc; font-size: 20px;"></i>
            </div>
        `;
    }
    
    return `
        <td style="text-align: center; vertical-align: middle; padding: 8px;">
            ${imageHTML}
        </td>
        <td><strong>${tool.code}</strong></td>
        <td>${tool.name}</td>
        <td>${tool.patrimonio || '-'}</td>
        <td>${tool.category}</td>
        <td><span class="status-badge ${statusClass}">${statusParaExibir}</span></td>
        <td>${tool.location}</td>
        <td>${tool.condition}</td>
        <td>${tool.unidade || 'UN'}</td>
        <td class="${stockInfo.class}">${stockInfo.text}</td>
        <td>${tool.preco ? formatCurrency(tool.preco) : '-'}</td>
        <td>${formatDate(tool.dataCadastro)}</td>
        <td>${tool.usuarioCadastro || '-'}</td>
        <td>
            <div class="action-buttons">
                <button class="action-btn action-btn-view" data-id="${tool.id}" title="Visualizar">
                    <i class="fas fa-eye"></i>
                </button>
                ${canEdit ? `
                    <button class="action-btn action-btn-edit" data-id="${tool.id}" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn action-btn-delete" data-id="${tool.id}" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
                <button class="action-btn action-btn-view" data-id="${tool.id}" title="Gerar QR Code" style="color: #8e44ad;">
                    <i class="fas fa-qrcode"></i>
                </button>
            </div>
        </td>
    `;
}

        function getStatusClass(status) {
            switch(status) {
                case 'Disponível': return 'status-completed';
                case 'Em Uso': return 'status-ontrack';
                case 'Manutenção': return 'status-delayed';
                case 'Danificado': return 'status-delayed';
                case 'Reservado': return 'status-delayed';
                case 'Descartado': return 'status-delayed';
                default: return 'status-ontrack';
            }
        }

        function getStockInfo(tool) {
            const quantidade = parseInt(tool.quantidade) || 0;
            const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
            
            if (estoqueMinimo > 0 && quantidade <= estoqueMinimo) {
                return { class: 'stock-low', text: `${quantidade} ⚠️` };
            } else if (tool.estoqueMaximo && quantidade >= tool.estoqueMaximo) {
                return { class: 'stock-high', text: quantidade };
            } else {
                return { class: 'stock-normal', text: quantidade };
            }
        }

        // ============================================
        // FUNÇÕES DE VISUALIZAÇÃO E EDIÇÃO
        // ============================================

        // Visualizar detalhes
        function viewToolDetails(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            const modalBody = document.getElementById('toolModalBody');
            modalBody.innerHTML = createToolDetailsHTML(tool);
            
            // Adicionar evento para clicar na imagem no modal
            const modalImage = modalBody.querySelector('img');
            if (modalImage) {
                modalImage.style.cursor = 'pointer';
                modalImage.addEventListener('click', function() {
                    viewEnlargedImage(toolId);
                });
            }
            
            document.getElementById('toolModal').style.display = 'flex';
        }

        function createToolDetailsHTML(tool) {
            return `
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <div>
                        ${tool.image ? 
                            `<img src="${tool.image}" alt="${tool.name}" style="width: 100%; border-radius: 8px; cursor: pointer;">` :
                            '<div style="background-color: #f5f5f5; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"><i class="fas fa-box" style="font-size: 60px; color: #ccc;"></i></div>'
                        }
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="generateQRCodeForTool(${tool.id})">
                                <i class="fas fa-qrcode"></i> Gerar QR Code
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 10px; color: var(--primary-color);">${tool.name}</h3>
                        <p style="color: var(--gray-color); margin-bottom: 20px;">Código: ${tool.code} | Patrimônio: ${tool.patrimonio || 'Não informado'}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div><strong>N.C.M.:</strong> ${tool.ncm || '-'}</div>
                            <div><strong>Categoria:</strong> ${tool.category}</div>
                            <div><strong>Status:</strong> <span class="status-badge ${getStatusClass(tool.status)}">${tool.status}</span></div>
                            <div><strong>Localização:</strong> ${tool.location}</div>
                            <div><strong>Condição:</strong> ${tool.condition}</div>
                            <div><strong>Unidade:</strong> ${tool.unidade || 'UN'}</div>
                            <div><strong>Nota Fiscal:</strong> ${tool.notaFiscal || '-'}</div>
                            <div><strong>Preço:</strong> ${formatCurrency(tool.preco)}</div>
                            <div><strong>Quantidade:</strong> ${tool.quantidade || 1}</div>
                            <div><strong>Estoque Mín:</strong> ${tool.estoqueMinimo || 0}</div>
                            <div><strong>Estoque Máx:</strong> ${tool.estoqueMaximo || 0}</div>
                            <div><strong>Data Cadastro:</strong> ${formatDate(tool.dataCadastro)}</div>
                            <div><strong>Usuário Cadastro:</strong> ${tool.usuarioCadastro || 'Sistema'}</div>
                        </div>
                        
                        ${tool.description ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Descrição:</strong>
                                <p>${tool.description}</p>
                            </div>
                        ` : ''}
                        
                        ${tool.observations ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Observações:</strong>
                                <p>${tool.observations}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Editar item
        function editTool(toolId) {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para editar itens.', 'error');
                return;
            }
            
            // Mudar para aba de cadastro
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="cadastro"]').classList.add('active');
            document.getElementById('cadastro').classList.add('active');
            
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            // Preencher formulário
            document.getElementById('toolName').value = tool.name;
            document.getElementById('toolCode').value = tool.code;
            document.getElementById('patrimonioNumber').value = tool.patrimonio || '';
            document.getElementById('ncmCode').value = tool.ncm || '';
            document.getElementById('toolCategory').value = tool.category;
            document.getElementById('toolStatus').value = tool.status;
            document.getElementById('toolLocation').value = tool.location;
            document.getElementById('toolCondition').value = tool.condition;
            document.getElementById('notaFiscal').value = tool.notaFiscal || '';
            document.getElementById('unidadeMedida').value = tool.unidade || 'UN';
            document.getElementById('preco').value = tool.preco || '';
            document.getElementById('quantidadeAtual').value = tool.quantidade || 1;
            document.getElementById('estoqueMinimo').value = tool.estoqueMinimo || 0;
            document.getElementById('estoqueMaximo').value = tool.estoqueMaximo || 0;
            document.getElementById('dataCadastro').value = tool.dataCadastro || '';
            document.getElementById('toolDescription').value = tool.description || '';
            document.getElementById('toolObservations').value = tool.observations || '';
            
            if (tool.image) {
                currentToolImage = tool.image;
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('toolImagePreview').style.display = 'block';
                document.getElementById('toolImagePreview').src = tool.image;
            }
            
            isEditing = true;
            editingToolId = toolId;
            
            document.getElementById('saveToolBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Item';
            
            showNotification('Editando item. Atualize os dados.', 'warning');
        }

        // Excluir item
        async function deleteTool(toolId) {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para excluir itens.', 'error');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }
            
            const tool = tools.find(t => t.id === toolId);
            if (!tool) {
                showNotification('Item não encontrado!', 'error');
                return;
            }
            
            // Remover localmente
            tools = tools.filter(t => t.id !== toolId);
            await saveTools();
            
            // Remover do Supabase
            if (isOnlineMode && supabaseClient) {
                try {
                    await supabaseClient
                        .from('tools')
                        .delete()
                        .eq('code', tool.code);
                } catch (error) {
                    console.error('Erro ao excluir do Supabase:', error);
                }
            }
            
            updateInterface();
            showNotification('Item excluído com sucesso!', 'success');
        }

        // Gerar QR Code
        window.generateQRCodeForTool = function(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            const qrContent = JSON.stringify({
                nome: tool.name,
                codigo: tool.code,
                patrimonio: tool.patrimonio,
                ncm: tool.ncm,
                categoria: tool.category,
                status: tool.status,
                localizacao: tool.location,
                condicao: tool.condition,
                data_cadastro: tool.dataCadastro,
                usuario_cadastro: tool.usuarioCadastro
            }, null, 2);
            
            const qrModalBody = document.getElementById('qrModalBody');
            qrModalBody.innerHTML = `
                <div class="qrcode-container">
                    <h4 style="margin-bottom: 20px;">QR Code para: ${tool.name}</h4>
                    <div id="qrcodeCanvas" style="margin: 0 auto 20px;"></div>
                    <p style="margin-top: 20px; color: var(--gray-color); font-size: 14px;">
                        Use este QR Code para identificar rapidamente o item.
                    </p>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="downloadQRCodeBtn">
                            <i class="fas fa-download"></i> Baixar QR Code
                        </button>
                        <button class="btn btn-success" id="printQRCodeBtn">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            `;
            
            // Gerar QR Code
            QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrContent, {
                width: 200,
                margin: 2,
                color: { dark: '#000000', light: '#FFFFFF' }
            });
            
            // Configurar botões
            document.getElementById('downloadQRCodeBtn').onclick = function() {
                const canvas = document.querySelector('#qrcodeCanvas canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `QRCode_${tool.code}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }
            };
            
            document.getElementById('printQRCodeBtn').onclick = function() {
                window.print();
            };
            
            document.getElementById('qrModal').style.display = 'flex';
        };

        // ============================================
        // FUNÇÕES DE SINCRONIZAÇÃO
        // ============================================

        // Enviar dados para Supabase
        async function syncToSupabase() {
            try {
                // Verificar permissão
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para sincronizar.', 'error');
                    return;
                }
                
                if (!isOnlineMode || !supabaseClient) {
                    showNotification('Não conectado à nuvem.', 'warning');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const tool of tools) {
                    try {
                        const result = await saveToolToSupabase(tool);
                        if (result) successCount++;
                        else errorCount++;
                    } catch (error) {
                        errorCount++;
                        console.error(`Erro ao sincronizar ${tool.code}:`, error);
                    }
                }
                
                if (errorCount === 0) {
                    showNotification(`${successCount} itens sincronizados com sucesso!`, 'success');
                    lastSyncTime = new Date();
                    updateConnectionStatus();
                } else {
                    showNotification(`${successCount} sucessos, ${errorCount} erros na sincronização.`, 'warning');
                }
                
                return true;
            } catch (error) {
                console.error('Erro na sincronização:', error);
                showNotification('Erro na sincronização.', 'error');
                return false;
            }
        }

        // Sincronizar ambos (enviar e buscar)
        async function syncBoth() {
            await syncToSupabase();
            await fetchFromSupabase();
        }

        // Atualizar status da conexão na interface
        function updateConnectionStatus() {
            const connectionStatus = document.getElementById('currentConnectionStatus');
            const operationMode = document.getElementById('operationMode');
            const lastSync = document.getElementById('lastSyncTime');
            const localItems = document.getElementById('localItemsCount');
            const statusIndicator = document.getElementById('dbStatusIndicator');
            const statusText = document.getElementById('connectionStatus');
            
            if (isOnlineMode && supabaseClient) {
                connectionStatus.textContent = 'Conectado';
                connectionStatus.style.color = 'var(--success-color)';
                operationMode.textContent = 'Online';
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Conectado à Nuvem';
                statusText.style.color = 'var(--success-color)';
            } else {
                connectionStatus.textContent = 'Desconectado';
                connectionStatus.style.color = 'var(--danger-color)';
                operationMode.textContent = 'Local';
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'Modo Local';
                statusText.style.color = 'var(--warning-color)';
            }
            
            if (lastSyncTime) {
                lastSync.textContent = lastSyncTime.toLocaleString('pt-BR');
            } else {
                lastSync.textContent = 'Nunca';
            }
            
            localItems.textContent = tools.length;
            
            // Atualizar contagem de itens na nuvem
            updateCloudItemsCount();
        }

        // Atualizar contagem de itens na nuvem
        async function updateCloudItemsCount() {
            const cloudItems = document.getElementById('cloudItemsCount');
            
            if (isOnlineMode && supabaseClient) {
                try {
                    const { count } = await supabaseClient
                        .from('tools')
                        .select('*', { count: 'exact', head: true });
                    
                    cloudItems.textContent = count || 0;
                } catch (error) {
                    cloudItems.textContent = 'Erro';
                }
            } else {
                cloudItems.textContent = 'Offline';
            }
        }

        // Atualizar informações do banco
        async function updateDatabaseInfo() {
            if (!supabaseClient) return;
            
            try {
                const { count } = await supabaseClient
                    .from('tools')
                    .select('*', { count: 'exact', head: true });
                
                updateConnectionStatus();
            } catch (error) {
                console.error('Erro ao atualizar info do banco:', error);
            }
        }

        // ============================================
        // FUNÇÕES DE BACKUP E EXPORTAÇÃO
        // ============================================

        // Fazer backup
        async function createBackup() {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para fazer backup.', 'error');
                return;
            }
            
            try {
                const backupData = {
                    tools: tools,
                    colaboradores: colaboradores,
                    historicoAtribuicoes: historicoAtribuicoes,
                    timestamp: new Date().toISOString(),
                    count: tools.length,
                    usuarios: Array.from(new Set(tools.map(t => t.usuarioCadastro).filter(Boolean)))
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_ferramentas_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Backup criado com ${tools.length} itens e ${colaboradores.length} colaboradores!`, 'success');
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showNotification('Erro ao criar backup.', 'error');
            }
        }

        // Restaurar backup
        function handleRestoreBackup(file) {
            // Verificar permissão
            if (currentUser.role === 'user') {
                showNotification('Usuário não tem permissão para restaurar backup.', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    if (!backupData.tools || !Array.isArray(backupData.tools)) {
                        showNotification('Arquivo de backup inválido.', 'error');
                        return;
                    }
                    
                    if (!confirm(`Restaurar backup com ${backupData.tools.length} itens e ${backupData.colaboradores?.length || 0} colaboradores? Os dados atuais serão substituídos.`)) {
                        return;
                    }
                    
                    tools = backupData.tools;
                    colaboradores = backupData.colaboradores || [];
                    historicoAtribuicoes = backupData.historicoAtribuicoes || [];
                    
                    await saveTools();
                    await saveColaboradores();
                    updateInterface();
                    
                    showNotification(`${backupData.tools.length} itens e ${colaboradores.length} colaboradores restaurados!`, 'success');
                    
                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    showNotification('Erro ao restaurar backup.', 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Erro ao ler arquivo.', 'error');
            };
            
            reader.readAsText(file);
        }

        // Exportar para Excel
        async function exportToExcel(range = 'all') {
            try {
                // Mostrar loader
                const loader = document.getElementById('exportLoader');
                loader.style.display = 'block';
                
                // Filtrar itens
                let filteredTools = tools;
                
                if (range === 'available') {
                    filteredTools = tools.filter(tool => tool.status === 'Disponível');
                } else if (range === 'inuse') {
                    filteredTools = tools.filter(tool => tool.status === 'Em Uso');
                } else if (range === 'maintenance') {
                    filteredTools = tools.filter(tool => tool.status === 'Manutenção');
                } else if (range === 'lowstock') {
                    filteredTools = tools.filter(tool => {
                        const quantidade = parseInt(tool.quantidade) || 0;
                        const estoqueMinimo = parseInt(tool.estoqueMinimo) || 0;
                        return estoqueMinimo > 0 && quantidade <= estoqueMinimo;
                    });
                }
                
                if (filteredTools.length === 0) {
                    loader.style.display = 'none';
                    showNotification('Nenhum item para exportar!', 'error');
                    return;
                }
                
                // Aba principal: Ferramentas
                const exportData = filteredTools.map(tool => ({
                    'Código': tool.code,
                    'Nome do Produto': tool.name,
                    'Patrimônio': tool.patrimonio || '',
                    'N.C.M.': tool.ncm,
                    'Categoria': tool.category,
                    'Status': tool.status,
                    'Localização': tool.location,
                    'Condição': tool.condition,
                    'Nota Fiscal': tool.notaFiscal || '',
                    'Unidade': tool.unidade || 'UN',
                    'Preço': tool.preco ? formatCurrencyForExport(tool.preco) : '0,00',
                    'Quantidade': tool.quantidade || 1,
                    'Estoque Mínimo': tool.estoqueMinimo || 0,
                    'Estoque Máximo': tool.estoqueMaximo || 0,
                    'Descrição': tool.description || '',
                    'Observações': tool.observations || '',
                    'Data Cadastro': tool.dataCadastro || '',
                    'Usuário Cadastro': tool.usuarioCadastro || 'Sistema',
                    'Data/Hora Cadastro': tool.dataHoraCadastro || ''
                }));
                
                // Aba Usuários: Resumo por usuário
                const usuariosMap = new Map();
                
                filteredTools.forEach(tool => {
                    const usuario = tool.usuarioCadastro || 'Sistema';
                    if (!usuariosMap.has(usuario)) {
                        usuariosMap.set(usuario, {
                            usuario: usuario,
                            totalItens: 0,
                            valorTotal: 0,
                            categorias: new Set(),
                            itensPorStatus: {}
                        });
                    }
                    
                    const userData = usuariosMap.get(usuario);
                    userData.totalItens += 1;
                    
                    const preco = parseFloat(tool.preco) || 0;
                    const quantidade = parseInt(tool.quantidade) || 1;
                    userData.valorTotal += preco * quantidade;
                    
                    userData.categorias.add(tool.category);
                    userData.itensPorStatus[tool.status] = (userData.itensPorStatus[tool.status] || 0) + 1;
                });
                
                const usuariosData = Array.from(usuariosMap.values()).map(userData => ({
                    'Usuário': userData.usuario,
                    'Total de Itens': userData.totalItens,
                    'Valor Total (R$)': formatCurrencyForExport(userData.valorTotal),
                    'Categorias': Array.from(userData.categorias).join(', '),
                    'Disponíveis': userData.itensPorStatus['Disponível'] || 0,
                    'Em Uso': userData.itensPorStatus['Em Uso'] || 0,
                    'Manutenção': userData.itensPorStatus['Manutenção'] || 0,
                    'Danificados': userData.itensPorStatus['Danificado'] || 0,
                    'Reservados': userData.itensPorStatus['Reservado'] || 0,
                    'Média por Item (R$)': userData.totalItens > 0 ? 
                        formatCurrencyForExport(userData.valorTotal / userData.totalItens) : '0,00'
                }));
                
                // Aba Colaboradores: Colaboradores e ferramentas atribuídas
                const colaboradoresData = colaboradores.map(colaborador => ({
                    'Nome': colaborador.nome,
                    'Matrícula': colaborador.matricula,
                    'Setor': colaborador.setor || '',
                    'Cargo': colaborador.cargo || '',
                    'Telefone': colaborador.telefone || '',
                    'Email': colaborador.email || '',
                    'Total Ferramentas': colaborador.ferramentasAtribuidas ? colaborador.ferramentasAtribuidas.length : 0,
                    'Observações': colaborador.observacoes || '',
                    'Data Cadastro': colaborador.dataCadastro || '',
                    'Usuário Cadastro': colaborador.usuarioCadastro || ''
                }));
                
                // Aba Histórico: Histórico de atribuições
                const historicoData = historicoAtribuicoes.map(item => ({
                    'Colaborador': item.colaboradorNome,
                    'Ferramenta': `${item.toolCodigo} - ${item.toolNome}`,
                    'Data Atribuição': item.dataAtribuicao,
                    'Data Devolução': item.dataDevolucao || 'Não devolvido',
                    'Observação': item.observacao || '',
                    'Usuário Atribuição': item.usuarioAtribuicao,
                    'Usuário Devolução': item.usuarioDevolucao || ''
                }));
                
                // Criar worksheets
                const wsTools = XLSX.utils.json_to_sheet(exportData);
                const wsUsuarios = XLSX.utils.json_to_sheet(usuariosData);
                const wsColaboradores = XLSX.utils.json_to_sheet(colaboradoresData);
                const wsHistorico = XLSX.utils.json_to_sheet(historicoData);
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, wsTools, 'Ferramentas');
                XLSX.utils.book_append_sheet(wb, wsUsuarios, 'Usuários');
                XLSX.utils.book_append_sheet(wb, wsColaboradores, 'Colaboradores');
                XLSX.utils.book_append_sheet(wb, wsHistorico, 'Histórico Atribuições');
                
                // Ajustar largura das colunas
                const wscolsTools = [
                    { wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 20 },
                    { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 10 },
                    { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 40 },
                    { wch: 40 }, { wch: 15 }, { wch: 20 }, { wch: 25 }
                ];
                wsTools['!cols'] = wscolsTools;
                
                const wscolsUsuarios = [
                    { wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, 
                    { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, 
                    { wch: 12 }, { wch: 20 }
                ];
                wsUsuarios['!cols'] = wscolsUsuarios;
                
                const wscolsColaboradores = [
                    { wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 20 },
                    { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 40 },
                    { wch: 15 }, { wch: 20 }
                ];
                wsColaboradores['!cols'] = wscolsColaboradores;
                
                const wscolsHistorico = [
                    { wch: 25 }, { wch: 30 }, { wch: 15 }, { wch: 15 },
                    { wch: 40 }, { wch: 20 }, { wch: 20 }
                ];
                wsHistorico['!cols'] = wscolsHistorico;
                
                // Adicionar títulos
                XLSX.utils.sheet_add_aoa(wsUsuarios, [[`Relatório por Usuário - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsTools, [[`Relatório de Ferramentas (${range}) - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsColaboradores, [[`Relatório de Colaboradores - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                XLSX.utils.sheet_add_aoa(wsHistorico, [[`Histórico de Atribuições - Gerado em ${new Date().toLocaleDateString('pt-BR')}`]], { origin: -1 });
                
                // Gerar nome do arquivo
                const fileName = `ferramentas_${range}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // Salvar arquivo
                XLSX.writeFile(wb, fileName);
                
                // Adicionar ao histórico
                addToExportHistory(range, filteredTools.length);
                
                showNotification(`${filteredTools.length} itens exportados em 4 abas!`, 'success');
                
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showNotification('Erro ao exportar.', 'error');
            } finally {
                document.getElementById('exportLoader').style.display = 'none';
            }
        }

        function addToExportHistory(range, count) {
            const exportHistory = document.getElementById('exportHistory');
            if (!exportHistory) return;
            
            const rangeText = {
                'all': 'Todos os itens',
                'available': 'Itens disponíveis',
                'inuse': 'Itens em uso',
                'maintenance': 'Itens em manutenção',
                'lowstock': 'Itens com estoque baixo'
            }[range] || range;
            
            const historyItem = document.createElement('div');
            historyItem.style.cssText = `
                display: flex; justify-content: space-between; align-items: center;
                padding: 15px; border-bottom: 1px solid var(--border-color);
            `;
            
            historyItem.innerHTML = `
                <div>
                    <p style="font-weight: 500; margin-bottom: 5px;">${rangeText}</p>
                    <p style="font-size: 14px; color: var(--gray-color);">${count} itens exportados</p>
                    <p style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                        <i class="fas fa-file-excel"></i> 4 abas: Ferramentas + Usuários + Colaboradores + Histórico
                    </p>
                </div>
                <div>
                    <span class="status-badge status-ontrack">Excel</span>
                    <p style="font-size: 14px; color: var(--gray-color); margin-top: 5px;">${new Date().toLocaleString('pt-BR')}</p>
                </div>
            `;
            
            if (exportHistory.querySelector('p')) {
                exportHistory.innerHTML = '';
            }
            
            exportHistory.insertBefore(historyItem, exportHistory.firstChild);
        }

        // ============================================
        // EVENT LISTENERS - CORRIGIDOS
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar sessão ativa
            checkSession();
            
            // Configurar data atual no rodapé
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR');
            
            // ===== LOGIN =====
            document.getElementById('loginBtn').addEventListener('click', login);
            
            // Permitir login com Enter
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // ===== LOGOUT =====
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ===== TABS =====
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'catalogo') {
                        loadToolsList(currentStatusFilter);
                    }
                    
                    if (tabId === 'controle-colaborador') {
                        updateColaboradoresList();
                    }
                    
                    if (tabId !== 'cadastro') {
                        isEditing = false;
                        editingToolId = null;
                        document.getElementById('saveToolBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Item';
                    }
                    
                    if (tabId !== 'controle-colaborador') {
                        isEditingColaborador = false;
                        currentColaboradorId = null;
                        clearColaboradorForm();
                        colaboradorSelecionado = null;
                        updateAtribuicaoUI();
                    }
                });
            });
            
            // ===== BOTÃO FIXO DE ENVIAR PARA NUVEM =====
            document.getElementById('fixedCloudUploadBtn').addEventListener('click', syncToSupabase);
            
            // ===== SINCRONIZAÇÃO =====
            document.getElementById('syncToOnlineBtn').addEventListener('click', syncToSupabase);
            document.getElementById('syncFromOnlineBtn2').addEventListener('click', fetchFromSupabase);
            document.getElementById('syncBothBtn').addEventListener('click', syncBoth);
            
            // ===== BOTÕES DE FILTRO POR STATUS =====
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover classe active de todos os botões de status
                    document.querySelectorAll('.status-filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Adicionar classe active no botão clicado
                    this.classList.add('active');
                    
                    // Remover active do botão de estoque baixo se estiver ativo
                    const lowStockBtn = document.getElementById('filterLowStockBtn');
                    if (lowStockBtn.classList.contains('active')) {
                        lowStockBtn.classList.remove('active');
                    }
                    
                    // Carregar lista com o filtro selecionado
                    const status = this.getAttribute('data-status');
                    loadToolsList(status);
                });
            });
            
            // ===== BOTÃO DE ESTOQUE BAIXO =====
            document.getElementById('filterLowStockBtn').addEventListener('click', function() {
                // Remover classe active de todos os botões de status
                document.querySelectorAll('.status-filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Adicionar active no botão de estoque baixo
                this.classList.toggle('active');
                
                // Remover active do botão "Todos" e carregar lista
                const isActive = this.classList.contains('active');
                if (isActive) {
                    loadToolsList('all'); // Carrega todos e filtra por estoque baixo
                } else {
                    document.querySelector('[data-status="all"]').classList.add('active');
                    loadToolsList('all');
                }
            });
            
            // ===== IMAGEM =====
            document.getElementById('captureImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para adicionar imagens.', 'error');
                    return;
                }
                document.getElementById('imageUploadInput').click();
            });
            
            document.getElementById('uploadImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para adicionar imagens.', 'error');
                    return;
                }
                document.getElementById('imageUploadInput').click();
            });
            
            document.getElementById('clearImageBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para modificar imagens.', 'error');
                    return;
                }
                document.getElementById('cameraPlaceholder').style.display = 'block';
                document.getElementById('toolImagePreview').style.display = 'none';
                document.getElementById('toolImagePreview').src = '';
                currentToolImage = null;
            });
            
            document.getElementById('imageUploadInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showNotification('Selecione uma imagem!', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('A imagem é muito grande. Máximo: 5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentToolImage = event.target.result;
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    document.getElementById('toolImagePreview').style.display = 'block';
                    document.getElementById('toolImagePreview').src = currentToolImage;
                };
                reader.readAsDataURL(file);
                
                this.value = '';
            });
            
            // ===== FORMULÁRIO =====
            document.getElementById('saveToolBtn').addEventListener('click', saveTool);
            
            document.getElementById('saveAndNewBtn').addEventListener('click', async function() {
                if (await saveTool()) {
                    clearForm();
                    if (document.getElementById('catalogo').classList.contains('active')) {
                        loadToolsList(currentStatusFilter);
                    }
                }
            });
            
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
            
            document.getElementById('generateQRCodeBtn').addEventListener('click', function() {
                showNotification('Preencha o formulário primeiro.', 'info');
            });
            
            // ===== BUSCA =====
            document.getElementById('searchTool')?.addEventListener('input', () => loadToolsList(currentStatusFilter));
            document.getElementById('searchColaborador')?.addEventListener('input', function() {
                updateColaboradoresList(this.value);
            });
            
            // ===== BACKUP =====
            document.getElementById('backupBtn').addEventListener('click', createBackup);
            document.getElementById('quickBackupBtn').addEventListener('click', createBackup);
            
            document.getElementById('restoreBtn').addEventListener('click', function() {
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para restaurar backup.', 'error');
                    return;
                }
                document.getElementById('restoreFileInput').click();
            });
            
            document.getElementById('restoreFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    showNotification('Selecione um arquivo JSON.', 'error');
                    return;
                }
                
                handleRestoreBackup(file);
                this.value = '';
            });
            
            // ===== EXPORTAÇÃO =====
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                const range = document.getElementById('exportRange').value;
                exportToExcel(range);
            });
            
            // ===== COLABORADORES =====
            document.getElementById('salvarColaboradorBtn').addEventListener('click', saveColaborador);
            document.getElementById('limparColaboradorBtn').addEventListener('click', clearColaboradorForm);
            document.getElementById('excluirColaboradorBtn').addEventListener('click', function() {
                if (currentColaboradorId) {
                    deleteColaborador(currentColaboradorId);
                }
            });
            
            document.getElementById('atribuirFerramentaBtn').addEventListener('click', atribuirFerramenta);
            document.getElementById('limparAtribuicaoBtn').addEventListener('click', function() {
                document.getElementById('ferramentaParaAtribuir').value = '';
                document.getElementById('observacaoAtribuicao').value = '';
                document.getElementById('dataAtribuicao').value = new Date().toISOString().split('T')[0];
            });
            
            // ===== MODAIS =====
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.getElementById('toolModal').style.display = 'none';
            });
            
            document.getElementById('closeQRModalBtn').addEventListener('click', function() {
                document.getElementById('qrModal').style.display = 'none';
            });
            
            document.getElementById('closeMapModalBtn').addEventListener('click', function() {
                document.getElementById('mapModal').style.display = 'none';
            });
            
            document.getElementById('closeFerramentasModalBtn').addEventListener('click', function() {
                document.getElementById('ferramentasColaboradorModal').style.display = 'none';
            });
            
            document.getElementById('toolModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('qrModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('mapModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            document.getElementById('ferramentasColaboradorModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // ===== LIMPAR CACHE - CORRIGIDO =====
            document.getElementById('clearCacheBtn').addEventListener('click', async function() {
                if (currentUser.role === 'user') {
                    showNotification('Usuário não tem permissão para limpar cache.', 'error');
                    return;
                }
                
                if (confirm('Limpar todos os dados locais? Esta ação não pode ser desfeita.')) {
                    try {
                        // 1. Limpa os dados
                        localStorage.removeItem('tools');
                        localStorage.removeItem('colaboradores');
                        localStorage.removeItem('historicoAtribuicoes');
                        
                        // 2. Carrega dados de exemplo
                        tools = getExampleTools();
                        colaboradores = getExampleColaboradores();
                        historicoAtribuicoes = [];
                        
                        // 3. Salva dados
                        await saveTools();
                        await saveColaboradores();
                        
                        // 4. Reconecta ao Supabase
                        isOnlineMode = false; // Força reinicialização
                        const connected = await setupSupabaseClient(); // Reconecta ao Supabase
                        
                        // 5. Atualiza interface
                        updateInterface();
                        updateAtribuicaoUI();
                        
                        // 6. Feedback
                        if (connected) {
                            showNotification('Dados limpos e reconectado à nuvem!', 'success');
                        } else {
                            showNotification('Dados limpos. Modo local ativo.', 'warning');
                        }
                    } catch (error) {
                        console.error('Erro ao limpar cache:', error);
                        console.error('Erro detalhado:', error.message);
                        showNotification(`Erro: ${error.message}`, 'error');
                    }
                }
            });
            
            // ===== OTIMIZAR =====
            document.getElementById('optimizeStorageBtn').addEventListener('click', function() {
                showNotification('Sistema otimizado!', 'success');
            });
        });
    </script>
</body>
</html>
